

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <meta name="description" content="第二章 垃圾回收本章内容：  如何判断对象可以回收 垃圾回收算法 分代垃圾回收 垃圾回收器 垃圾回收调优  2.1 如何判断对象可以回收2.1.1 引用计数法顾名思义，此种算法会在每一个对象上记录这个对象被引用的次数，只要有任何一个对象引用了次对象，这个对象的计数器就+1，取消对这个对象的引用时，计数器就-1。任何一个时刻，如果该对象的计数器为0，那么这个对象就是可以回收的。 弊端：可能存在循环引">
<meta property="og:type" content="article">
<meta property="og:title" content="第二章 垃圾回收">
<meta property="og:url" content="http://example.com/2022/02/02/%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/index.html">
<meta property="og:site_name" content="密鼬CyrptoSkunk">
<meta property="og:description" content="第二章 垃圾回收本章内容：  如何判断对象可以回收 垃圾回收算法 分代垃圾回收 垃圾回收器 垃圾回收调优  2.1 如何判断对象可以回收2.1.1 引用计数法顾名思义，此种算法会在每一个对象上记录这个对象被引用的次数，只要有任何一个对象引用了次对象，这个对象的计数器就+1，取消对这个对象的引用时，计数器就-1。任何一个时刻，如果该对象的计数器为0，那么这个对象就是可以回收的。 弊端：可能存在循环引">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126222346273.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/1460000023838477">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126230305870.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126230917849.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126231016123.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126231450669.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127110859359.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127110920966.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127111954211.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127112502360.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127112809512.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127113203936.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127113333844.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127113549470.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127135307614.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127140057157.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127140113442.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127140929880.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127141125626.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127142754103.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220127143232356.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128222929252.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128223623050.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128224432197.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128225002982.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128225113936.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128225516448.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128230128163.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128230147031.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220128230205689.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220129154032961.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220129154854580.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220129155832652.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220129160754037.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220129164910714.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220129165020111.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220130232036389.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220131135952292.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220131140803550.png">
<meta property="article:published_time" content="2022-02-01T16:08:06.000Z">
<meta property="article:modified_time" content="2022-02-01T16:09:24.096Z">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://image.cryptomartin.top/img/image-20220126222346273.png">
  
  <title>第二章 垃圾回收 - 密鼬CyrptoSkunk</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":false,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>密鼬cryptoskunk</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第二章 垃圾回收">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-02-02 00:08" pubdate>
        2022年2月2日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      24k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      75 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第二章 垃圾回收</h1>
            
            <div class="markdown-body">
              <h1 id="第二章-垃圾回收"><a href="#第二章-垃圾回收" class="headerlink" title="第二章 垃圾回收"></a>第二章 垃圾回收</h1><p>本章内容：</p>
<ul>
<li>如何判断对象可以回收</li>
<li>垃圾回收算法</li>
<li>分代垃圾回收</li>
<li>垃圾回收器</li>
<li>垃圾回收调优</li>
</ul>
<h2 id="2-1-如何判断对象可以回收"><a href="#2-1-如何判断对象可以回收" class="headerlink" title="2.1 如何判断对象可以回收"></a>2.1 如何判断对象可以回收</h2><h3 id="2-1-1-引用计数法"><a href="#2-1-1-引用计数法" class="headerlink" title="2.1.1 引用计数法"></a>2.1.1 引用计数法</h3><p>顾名思义，此种算法会在每一个对象上记录这个对象被引用的次数，只要有任何一个对象引用了次对象，这个对象的计数器就+1，取消对这个对象的引用时，计数器就-1。任何一个时刻，如果该对象的计数器为0，那么这个对象就是可以回收的。</p>
<p>弊端：可能存在循环引用</p>
<p><img src="http://image.cryptomartin.top/img/image-20220126222346273.png" srcset="/img/loading.gif" lazyload alt="image-20220126222346273"></p>
<blockquote>
<p>这种情况不会被垃圾回收。Java不采用引用计数法</p>
</blockquote>
<h3 id="2-1-2-可达性分析算法"><a href="#2-1-2-可达性分析算法" class="headerlink" title="2.1.2 可达性分析算法"></a>2.1.2 可达性分析算法</h3><p>可达性分析算法的主要思路是先找出一批根节点对象集合作为GC Roots（可称为根节点枚举），然后从这批根节点出发，查找其引用关系（类似于深度优先搜索），最终形成如下图这样的反映对象间依赖关系的图，若某些对象没有任何引用链与GC Roots相连（如下图中的Object5,Object6,Object7），则说明这些对象就是垃圾对象，是可以被垃圾收集器回收的。</p>
<p><img src="http://image.cryptomartin.top/img/1460000023838477" srcset="/img/loading.gif" lazyload alt="image-20200829145357624"></p>
<ul>
<li>Java 虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象</li>
<li>扫描堆中的对象，看是否能够沿着 GC Root对象 为起点的引用链找到该对象，找不到，表示可以回收</li>
<li>哪些对象可以作为 GC Root ?</li>
</ul>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        List&lt;Object&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;a&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;b&quot;</span>);<br>        System.out.println(<span class="hljs-number">1</span>);<br>        System.in.read();<br><br>        list=<span class="hljs-keyword">null</span>;<br>        System.out.println(<span class="hljs-number">2</span>);<br>        System.in.read();<br>        System.out.println(<span class="hljs-string">&quot;end...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>先<code>jps</code>查出进程号为：10644</p>
</li>
<li><p><code>jmap -dump:format=b,live,file=1.bin 10644</code>          (<code>dump</code>:堆内存当前运行时状态存为一个文件;<code>format=b</code>:指定为二进制格式;<code>live</code>:只关心存活的对象，且在抓快照之前进行一次垃圾回收;<code>file=1.bin</code>:文件存在哪里？)</p>
<p><code>jmap -dump:format=b,live,file=2.bin 10644</code>  生成2.bin</p>
</li>
<li><p>使用<code>Memory Analyzer</code>进行分析 <a target="_blank" rel="noopener" href="https://eclipse.org/mat/downloads.php">MAT下载地址</a></p>
</li>
</ol>
<p><img src="http://image.cryptomartin.top/img/image-20220126230305870.png" srcset="/img/loading.gif" lazyload alt="image-20220126230305870"></p>
<p>查看<code>1.bin</code></p>
<p><code>gc root</code>可以分为四大类</p>
<p><img src="http://image.cryptomartin.top/img/image-20220126230917849.png" srcset="/img/loading.gif" lazyload alt="image-20220126230917849"></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126231016123.png" srcset="/img/loading.gif" lazyload alt="image-20220126231016123"></p>
<p>图中所指，为代码中局部变量<code>list</code>所引用的对象<code>new ArrayList&lt;&gt;() </code>，可以作为一个<code>gc root</code></p>
<p>查看<code>2.bin</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126231450669.png" srcset="/img/loading.gif" lazyload alt="image-20220126231450669"></p>
<p>没有了<code>1.bin</code>中的<code>ArrayList</code>了。为什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">list=<span class="hljs-keyword">null</span>;<br>System.out.println(<span class="hljs-number">2</span>);<br>System.in.read();<br>System.out.println(<span class="hljs-string">&quot;end...&quot;</span>);<br></code></pre></td></tr></table></figure>

<p><code>jmap -dump:format=b,live,file=2.bin 10644</code>,<code>live</code>执行了一次垃圾回收，把没有人引用的对象<code>new ArrayList&lt;&gt;()</code>对象回收了。</p>
<h3 id="2-1-3-四种引用"><a href="#2-1-3-四种引用" class="headerlink" title="2.1.3 四种引用"></a>2.1.3 四种引用</h3><h4 id="2-1-3-1四种引用介绍"><a href="#2-1-3-1四种引用介绍" class="headerlink" title="2.1.3.1四种引用介绍"></a>2.1.3.1四种引用介绍</h4><ol>
<li>强引用<ul>
<li>只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</li>
</ul>
</li>
<li>弱引用（WeakReference）<ul>
<li>仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象</li>
<li>可以配合引用队列来释放弱引用自身</li>
</ul>
</li>
<li>软引用（SoftReference）<ul>
<li>仅有软引用引用该对象时，在垃圾回收后，内存仍不足时会再次出发垃圾回收，回收软引用对象</li>
<li>可以配合引用队列来释放软引用自身</li>
</ul>
</li>
<li>虚引用（PhantomReference）<ul>
<li>必须配合引用队列使用，主要配合 ByteBuffer 使用，被引用对象回收时，会将虚引用入队，由 Reference Handler 线程调用虚引用相关方法释放直接内存</li>
</ul>
</li>
<li>终结器引用（FinalReference）<ul>
<li>无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由 Finalizer 线程通过终结器引用找到被引用对象并调用它的 finalize方法，第二次 GC 时才能回收被引用对象</li>
</ul>
</li>
</ol>
<p><strong>强引用</strong></p>
<p><img src="http://image.cryptomartin.top/img/image-20220127110859359.png" srcset="/img/loading.gif" lazyload alt="image-20220127110859359"></p>
<p>A1对象， C对象和B对象都不【强引用】A1对象，A1对象才会被垃圾回收</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127110920966.png" srcset="/img/loading.gif" lazyload alt="image-20220127110920966"></p>
<p><strong>弱引用和软引用</strong></p>
<p>软/弱引用跟强引用的区别：只要A2对象，A3对象直接地被强引用所引用，当垃圾回收发生时，都有可能被回收掉。</p>
<p>A2对象被C对象【强引用】一个【软引用】对象，然后通过【软引用】对象引用到A2对象，这算是一种间接途径。并且被B对象【强引用】，这种情况下，A2对象是不会被垃圾回收的。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127111954211.png" srcset="/img/loading.gif" lazyload alt="image-20220127111954211"></p>
<p>当A2对象，没有被B对象【强引用】，没有其他任何【强引用】。只要满足下面的条件，A2对象是会被垃圾回收掉的：</p>
<ul>
<li>当垃圾回收发生时并且内存不够时</li>
</ul>
<p>这时，系统认为【软引用】引用的对象不够重要，当内存不够时，把它回收掉，腾出空间给更有用的对象来使用。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127112502360.png" srcset="/img/loading.gif" lazyload alt="image-20220127112502360"></p>
<p>【弱引用】跟【软引用】非常像，也是当没有任何【强引用】引用A3对象，回收条件更宽松，只要发生了垃圾回收，不管内存是否充足。</p>
<p>都会被垃圾回收掉。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127112809512.png" srcset="/img/loading.gif" lazyload alt="image-20220127112809512"></p>
<p>【软/弱引用】还可以配合【引用队列】来一起工作。</p>
<p>【软引用】引用的对象被回收掉后，【软引用】自身也是一个对象，【软引用】在创建时会被分配一个【引用队列】，当【软引用】引用的对象被垃圾回收掉后，【软引用】就会进入【引用队列】。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127113203936.png" srcset="/img/loading.gif" lazyload alt="image-20220127113203936"></p>
<p>【弱引用】也是类似，【弱引用】引用的对象被垃圾回收掉后，【弱引用】也会进入【引用队列】</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127113333844.png" srcset="/img/loading.gif" lazyload alt="image-20220127113333844"></p>
<p>【软引用】【弱引用】占用的内存进行释放，需要【引用队列】来找到它们，做进一步的处理。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127113549470.png" srcset="/img/loading.gif" lazyload alt="image-20220127113549470"></p>
<hr>
<p><strong>虚引用和终结器引用</strong></p>
<p>【软/弱引用】既可以配合【引用队列】使用，也可以不配合【引用队列】使用。</p>
<p>【虚引用】和终结器引用必须配合【引用队列】来使用</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127135307614.png" srcset="/img/loading.gif" lazyload alt="image-20220127135307614"></p>
<p>当【虚引用】创建出来时，会关联一个【引用队列】；当【终结器引用】创建出来时，也会关联一个【引用队列】；</p>
<p>【虚引用】在创建<code>ByteBuffer</code>时，会创建一个叫<code>Cleaner</code>的【虚引用对象】，<code>ByteBuffer</code>会分配一块【直接内存】，并且会把【直接内存】的地址会传给【虚引用对象】<code>Cleaner</code></p>
<p>如果<code>ByteBuffer</code>没有【强引用】来引用它了，<code>ByteBuffer</code>自己就会被垃圾回收掉。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127140057157.png" srcset="/img/loading.gif" lazyload alt="image-20220127140057157"></p>
<p><img src="http://image.cryptomartin.top/img/image-20220127140113442.png" srcset="/img/loading.gif" lazyload alt="image-20220127140113442"></p>
<p>然而<code>ByteBuffer</code>分配的【直接内存】并不能被Java垃圾回收所管理。如何解决呢？</p>
<p>就是在<code>ByteBufffer</code>被垃圾回收时，让【虚引用对象】进入【引用队列】。【虚引用】所在的【引用队列】会有一个<code>referrencehandler</code>的线程会定时地找有没有新入队的<code>Cleaner</code>。如果有，它就会调用<code>Cleaner</code>中的<code>clean()</code>方法，会根据前面记录的【直接内存】的地址，调用<code>Unsafe.freeMemory</code>，会把对应的直接内存释放掉。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127140929880.png" srcset="/img/loading.gif" lazyload alt="image-20220127140929880"></p>
<p>这样处理就保证【直接内存】不会导致内存泄漏。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127141125626.png" srcset="/img/loading.gif" lazyload alt="image-20220127141125626"></p>
<p>【终结器引用】，所有的Java对象都继承Object父类，而Object都有<code>finallize()</code>的方法，终结方法。</p>
<p>当A4对象重写了<code>finallize()</code>方法且没有【强引用】来引用它时，这时进行垃圾回收。那么，<code>finallize()</code>方法什么时候被调用呢？靠【终结器引用】</p>
<p>当A4对象重写了<code>finallize()</code>方法且没有【强引用】来引用它时，JVM会创建A4对象对应的【终结器引用】；当A4对象被垃圾回收时，会把【终结器引用】加入到【引用队列】。注意：这时，A4对象还没有被垃圾回收。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127142754103.png" srcset="/img/loading.gif" lazyload alt="image-20220127142754103"></p>
<p>这时A4不是立即垃圾回收，再由一个优先级很低的线程，在某时刻该线程会查看【引用队列中】是否有一个【终结器引用】，会找到【终结器】引用的对象A4，并且调用A4对象的<code>finallize()</code>方法，等调用完后，下一次垃圾回收时，会把A4对象占用的内存真正释放掉。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220127143232356.png" srcset="/img/loading.gif" lazyload alt="image-20220127143232356"></p>
<blockquote>
<p><code>finallize()</code>方法效率很低，第一次垃圾回收时没有真正回收掉；而是把【终结器引用】入队后，优先级很低的线程执行的机会很少，对象的<code>finallize()</code>方法迟迟没有被调用，对象占用的内存也迟迟没有被释放。</p>
<p>所以，不推荐用<code>finallize()</code>来释放资源！</p>
</blockquote>
<h4 id="2-1-3-2-软引用-应用"><a href="#2-1-3-2-软引用-应用" class="headerlink" title="2.1.3.2 软引用_应用"></a>2.1.3.2 软引用_应用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示软引用</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_3</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _4MB=<span class="hljs-number">4</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        List&lt;<span class="hljs-keyword">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_4MB]);<br>        &#125;<br>        System.in.read();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space<br>	at com.sunk.jvm.t2.Demo2_3.main(Demo2_3.java:<span class="hljs-number">17</span>)<br></code></pre></td></tr></table></figure>



<p>例如有一个场景：byte[]是读取网络上的图片，这些图片显示需要放到一个<code>list</code>集合中,但是这些图片资源不属于核心业务资源。图片数量过多，使用【强引用】来引用这些图片资源，会导致内存溢出的错误。</p>
<p>解决思路：这些不重要的资源，在内存紧张时，把它占用的内存释放掉。以后用到某图片，可以再次读取一次该图片。【强引用】不适合该场景。可以考虑采用【软引用】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">soft</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">//list --&gt; SoftReference --&gt; byte[]</span><br>    List&lt;SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>        SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_4MB]);<br>        System.out.println(ref.get());<br>        list.add(ref);<br>        System.out.println(list.size());<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;循环结束：&quot;</span> + list.size());<br>    <span class="hljs-keyword">for</span> (SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt; ref : list) &#123;<br>        System.out.println(ref.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>List是先强引用软引用对象SoftReference,软引用对象然后软引用byte[]数组</p>
<p>执行<code>soft</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">[B@330bedb4<br><span class="hljs-number">1</span><br>[B@2503dbd3<br><span class="hljs-number">2</span><br>[B@4b67cf4d<br><span class="hljs-number">3</span><br>[B@7ea987ac<br><span class="hljs-number">4</span><br>[B@12a3a380<br><span class="hljs-number">5</span><br>循环结束：<span class="hljs-number">5</span><br><span class="hljs-keyword">null</span><br><span class="hljs-keyword">null</span><br><span class="hljs-keyword">null</span><br><span class="hljs-keyword">null</span><br>[B@12a3a380<br><br></code></pre></td></tr></table></figure>

<p>发现：加了5次4MB的对象，并没有造成内存溢出(VM options设置:-Xmx20m)，循环5次。但是等循环结束，再次循环5次，调用软引用的get，前4个都变成了null，最后一个保留了。</p>
<p>再深入看一下垃圾回收过程，<code>VM options：-Xmx20m -XX:+PrintGCDetails -verbose:gc</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">[B@330bedb4<br><span class="hljs-number">1</span><br>[B@2503dbd3<br><span class="hljs-number">2</span><br>[B@4b67cf4d<br><span class="hljs-number">3</span><br>[GC (Allocation Failure) [PSYoungGen: 1934K-&gt;504K(6144K)] 14222K-&gt;12981K(19968K), <span class="hljs-number">0.0012385</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@7ea987ac<br><span class="hljs-number">4</span><br>[GC (Allocation Failure) --[PSYoungGen: 4825K-&gt;4825K(6144K)] 17303K-&gt;17399K(19968K), <span class="hljs-number">0.0009838</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Ergonomics)</span> [PSYoungGen: 4825K-&gt;4566<span class="hljs-title">K</span><span class="hljs-params">(6144K)</span>] [ParOldGen: 12573K-&gt;12477<span class="hljs-title">K</span><span class="hljs-params">(13824K)</span>] 17399K-&gt;17043<span class="hljs-title">K</span><span class="hljs-params">(19968K)</span>, [Metaspace: 3301K-&gt;3301<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0055370 secs] [Times: user</span>=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[GC (Allocation Failure) --[PSYoungGen: 4566K-&gt;4566K(6144K)] 17043K-&gt;17043K(19968K), <span class="hljs-number">0.0008829</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Allocation Failure)</span> [PSYoungGen: 4566K-&gt;0<span class="hljs-title">K</span><span class="hljs-params">(6144K)</span>] [ParOldGen: 12477K-&gt;641<span class="hljs-title">K</span><span class="hljs-params">(8704K)</span>] 17043K-&gt;641<span class="hljs-title">K</span><span class="hljs-params">(14848K)</span>, [Metaspace: 3301K-&gt;3301<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0054372 secs] [Times: user</span>=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] <br>[B@12a3a380<br><span class="hljs-number">5</span><br>循环结束：<span class="hljs-number">5</span><br><span class="hljs-keyword">null</span><br><span class="hljs-keyword">null</span><br><span class="hljs-keyword">null</span><br><span class="hljs-keyword">null</span><br>[B@12a3a380<br>Heap<br> PSYoungGen      total 6144K, used 4263K [<span class="hljs-number">0x00000000ff980000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>  eden space 5632K, <span class="hljs-number">75</span>% used [<span class="hljs-number">0x00000000ff980000</span>,<span class="hljs-number">0x00000000ffda9c88</span>,<span class="hljs-number">0x00000000fff00000</span>)<br>  from space 512K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000fff00000</span>,<span class="hljs-number">0x00000000fff00000</span>,<span class="hljs-number">0x00000000fff80000</span>)<br>  to   space 512K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000fff80000</span>,<span class="hljs-number">0x00000000fff80000</span>,<span class="hljs-number">0x0000000100000000</span>)<br> ParOldGen       total 8704K, used 641K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff480000</span>, <span class="hljs-number">0x00000000ff980000</span>)<br>  object space 8704K, <span class="hljs-number">7</span>% used [<span class="hljs-number">0x00000000fec00000</span>,<span class="hljs-number">0x00000000feca0538</span>,<span class="hljs-number">0x00000000ff480000</span>)<br> Metaspace       used 3308K, capacity 4500K, committed 4864K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 360<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 388<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br><span class="hljs-class"></span><br><span class="hljs-class"><span class="hljs-title">Process</span> <span class="hljs-title">finished</span> <span class="hljs-title">with</span> <span class="hljs-title">exit</span> <span class="hljs-title">code</span> 0</span><br><span class="hljs-class"></span><br></code></pre></td></tr></table></figure>

<p>第3次循环分配失败，触发了垃圾回收，新生代:<code>PSYoungGen: 1934K-&gt;504K(6144K)</code>，内存空闲了不少。</p>
<p>第4次循环内存还是不够，触发了垃圾回收，新生代:<code>PSYoungGen: 4825K-&gt;4825K(6144K)</code>,效率不高；所以触发了<code>Full GC</code>，不光回收新生代，还回收老年代，<code>[PSYoungGen: 4825K-&gt;4566K(6144K)] [ParOldGen: 12573K-&gt;12477K(13824K)]</code>,结果还是没回收多少。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_4MB]);<br>System.out.println(ref.get());<br>list.add(ref);<br>System.out.println(list.size());<span class="hljs-comment">//先添加，再打印list的大小。</span><br></code></pre></td></tr></table></figure>

<p>前4次循环，已经把内存占满了，想放第5个byte[]数组时放不下了。一次<code>Full GC</code>内存空间仍然不够，这时触发了软引用的内存回收。会把软引用引用的对象释掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">[GC (Allocation Failure) --[PSYoungGen: 4566K-&gt;4566K(6144K)] 17043K-&gt;17043K(19968K), <span class="hljs-number">0.0008829</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Allocation Failure)</span> [PSYoungGen: 4566K-&gt;0<span class="hljs-title">K</span><span class="hljs-params">(6144K)</span>] [ParOldGen: 12477K-&gt;641<span class="hljs-title">K</span><span class="hljs-params">(8704K)</span>] 17043K-&gt;641<span class="hljs-title">K</span><span class="hljs-params">(14848K)</span>, [Metaspace: 3301K-&gt;3301<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0054372 secs] [Times: user</span>=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] <br></code></pre></td></tr></table></figure>

<p>最后一次，<code>PSYoungGen: 4566K-&gt;0K(6144K)</code>新生代的内存占用变为0，<code>ParOldGen: 12477K-&gt;641K(8704K)</code>老年代的内存占用变为641k。代价就是把前4个Byte[]数组对象占用的内存释放掉，只有最后1个Byte[]数组没释放。</p>
<blockquote>
<p>在内存敏感的场景中，把不重要的资源用软引用去引用，当内存紧张时，可以把软引用的对象占用的内存回收掉。</p>
</blockquote>
<p>在上面的输出结果中，有效的只有最后1个，其他为null的无效了。我们希望把无用的软引用进行清理，因为软引用对象本身也是占用内存的。</p>
<p>如何清理无用的软引用？使用引用队列！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示软引用，配合引用队列</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_4</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _4MB = <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        List&lt;SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br><br><br>        <span class="hljs-comment">//引用队列</span><br>        ReferenceQueue&lt;<span class="hljs-keyword">byte</span>[]&gt; queue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-comment">//关联了引用队列，当软引用所关联的byte[]数组对象被回收时，软引用自己会加入到引用队列queue中去。</span><br>            SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_4MB],queue);<br>            System.out.println(ref.get());<br>            list.add(ref);<br>            System.out.println(list.size());<br>        &#125;<br><br>        <span class="hljs-comment">//去除掉无用的软引用</span><br>        Reference&lt;? extends <span class="hljs-keyword">byte</span>[]&gt; poll = queue.poll();<br>        <span class="hljs-keyword">while</span> (poll!= <span class="hljs-keyword">null</span>)&#123;<br>            list.remove(poll);<br>            <span class="hljs-comment">//在引用队列中回去下一个无用的软引用；因为无用的软引用才会加入到引用队列queue中</span><br>            poll= queue.poll();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;循环结束：&quot;</span> + list.size());<br>        <span class="hljs-keyword">for</span> (SoftReference&lt;<span class="hljs-keyword">byte</span>[]&gt; ref : list) &#123;<br>            System.out.println(ref.get());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注：VM记得加：<code>-Xmx20m</code></p>
<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">[B@330bedb4<br><span class="hljs-number">1</span><br>[B@2503dbd3<br><span class="hljs-number">2</span><br>[B@4b67cf4d<br><span class="hljs-number">3</span><br>[B@7ea987ac<br><span class="hljs-number">4</span><br>[B@12a3a380<br><span class="hljs-number">5</span><br>循环结束：<span class="hljs-number">1</span><br>[B@12a3a380<br></code></pre></td></tr></table></figure>

<p>成功地消除了无用的软引用！</p>
<h4 id="2-1-3-3-弱引用-示例"><a href="#2-1-3-3-弱引用-示例" class="headerlink" title="2.1.3.3 弱引用_示例"></a>2.1.3.3 弱引用_示例</h4><p>弱引用跟软引用很类似。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示弱引用</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_5</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _4MB = <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//list</span><br>        List&lt;WeakReference&lt;<span class="hljs-keyword">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            WeakReference&lt;<span class="hljs-keyword">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_4MB]);<br>            list.add(ref);<br>            <span class="hljs-keyword">for</span> (WeakReference&lt;<span class="hljs-keyword">byte</span>[]&gt; w : list) &#123;<br>                System.out.print(w.get() + <span class="hljs-string">&quot; &quot;</span>);<br>            &#125;<br>            System.out.println();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;循环结束：&quot;</span> + list.size());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">[B@330bedb4 <br>[B@330bedb4 [B@2503dbd3 <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d <br>[GC (Allocation Failure) [PSYoungGen: 1934K-&gt;488K(6144K)] 14222K-&gt;13025K(19968K), <span class="hljs-number">0.0011759</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d [B@7ea987ac <br>[GC (Allocation Failure) [PSYoungGen: 4696K-&gt;488K(6144K)] 17234K-&gt;13105K(19968K), <span class="hljs-number">0.0013181</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d <span class="hljs-keyword">null</span> [B@12a3a380 <br>[GC (Allocation Failure) [PSYoungGen: 4696K-&gt;480K(6144K)] 17313K-&gt;13097K(19968K), <span class="hljs-number">0.0009407</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> [B@29453f44 <br>[GC (Allocation Failure) [PSYoungGen: 4687K-&gt;480K(6144K)] 17304K-&gt;13097K(19968K), <span class="hljs-number">0.0007364</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> [B@5cad8086 <br>[GC (Allocation Failure) [PSYoungGen: 4686K-&gt;496K(6144K)] 17304K-&gt;13121K(19968K), <span class="hljs-number">0.0012411</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> [B@6e0be858 <br>[GC (Allocation Failure) [PSYoungGen: 4702K-&gt;512K(5120K)] 17328K-&gt;13137K(18944K), <span class="hljs-number">0.0007849</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[B@330bedb4 [B@2503dbd3 [B@4b67cf4d <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> [B@61bbe9ba <br>[GC (Allocation Failure) [PSYoungGen: 4698K-&gt;96K(5632K)] 17323K-&gt;13137K(19456K), <span class="hljs-number">0.0006953</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Ergonomics)</span> [PSYoungGen: 96K-&gt;0<span class="hljs-title">K</span><span class="hljs-params">(5632K)</span>] [ParOldGen: 13041K-&gt;659<span class="hljs-title">K</span><span class="hljs-params">(8192K)</span>] 13137K-&gt;659<span class="hljs-title">K</span><span class="hljs-params">(13824K)</span>, [Metaspace: 3299K-&gt;3299<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0071561 secs] [Times: user</span>=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] <br><span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">null</span> [B@610455d6 <br>循环结束：<span class="hljs-number">10</span><br>Heap<br> PSYoungGen      total 5632K, used 4278K [<span class="hljs-number">0x00000000ff980000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>  eden space 4608K, <span class="hljs-number">92</span>% used [<span class="hljs-number">0x00000000ff980000</span>,<span class="hljs-number">0x00000000ffdadae8</span>,<span class="hljs-number">0x00000000ffe00000</span>)<br>  from space 1024K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ffe00000</span>,<span class="hljs-number">0x00000000ffe00000</span>,<span class="hljs-number">0x00000000fff00000</span>)<br>  to   space 1024K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000fff00000</span>,<span class="hljs-number">0x00000000fff00000</span>,<span class="hljs-number">0x0000000100000000</span>)<br> ParOldGen       total 8192K, used 659K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff980000</span>)<br>  object space 8192K, <span class="hljs-number">8</span>% used [<span class="hljs-number">0x00000000fec00000</span>,<span class="hljs-number">0x00000000feca4e70</span>,<span class="hljs-number">0x00000000ff400000</span>)<br> Metaspace       used 3308K, capacity 4500K, committed 4864K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 359<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 388<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br><span class="hljs-class"></span><br><span class="hljs-class"><span class="hljs-title">Process</span> <span class="hljs-title">finished</span> <span class="hljs-title">with</span> <span class="hljs-title">exit</span> <span class="hljs-title">code</span> 0</span><br><span class="hljs-class"></span><br></code></pre></td></tr></table></figure>

<p>第9次循环时，有4个弱引用；但在第10次循环时，只有最后1个弱引用，因为弱引用本身也占用内存，导致内存不足，弱引用引用的对象被垃圾回收。</p>
<p>如想清理无用的弱引用，需要配合引用队列来使用。跟清理无用的软引用类似！</p>
<h2 id="2-2-垃圾回收算法"><a href="#2-2-垃圾回收算法" class="headerlink" title="2.2 垃圾回收算法"></a>2.2 垃圾回收算法</h2><h3 id="2-2-1-标记-清除算法"><a href="#2-2-1-标记-清除算法" class="headerlink" title="2.2.1 标记-清除算法"></a>2.2.1 标记-清除算法</h3><p>最基础的收集算法时”标记-清除“(Mark-Sweep)算法。算法分为”标记“和”清除“两个阶段。</p>
<p>首先，标记出所有需要回收的对象，然后在标记完成后统一回收所有被标记的对象。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220128222929252.png" srcset="/img/loading.gif" lazyload alt="image-20220128222929252"></p>
<p>对对象所占用的内存空间进行释放，这里有人会有误区：释放，是不是要把所需要释放的内存清零呢？注意，不需要！</p>
<p>把对象所占用的内存起始结束的地址记录下来，放在一个空闲的地址列表里。下次分配新对象的时候，去空闲列表中有没有一块合适的内存空间容纳新对象；如果有，进行一个内存分配，并不会把内存进行清零处理。</p>
<p><strong>标记-清除 算法的优缺点</strong></p>
<p>优点</p>
<ul>
<li>垃圾回收速度快，只需要记录所回收对象所占用的内存起始结束的地址</li>
</ul>
<p>缺点</p>
<ul>
<li>容易产生大量不连续的内存碎片</li>
</ul>
<h3 id="2-2-2-标记-整理算法"><a href="#2-2-2-标记-整理算法" class="headerlink" title="2.2.2 标记-整理算法"></a>2.2.2 标记-整理算法</h3><p><img src="http://image.cryptomartin.top/img/image-20220128223623050.png" srcset="/img/loading.gif" lazyload alt="image-20220128223623050"></p>
<p>”标记-整理“(Mark-Compact)算法，标记过程跟”标记-清除“算法一样，但是第二步整理，不是直接对可回收对象进行清除，而是让所有存货的对象都想一端移动，然后直接清除掉端边界以外的内存。</p>
<p><strong>标记-整理算法优缺点</strong></p>
<p>优点</p>
<ul>
<li>没有内存碎片</li>
</ul>
<p>缺点</p>
<ul>
<li>整理过程涉及到对象的移动，必然效率变低。</li>
</ul>
<h3 id="2-2-3-复制算法"><a href="#2-2-3-复制算法" class="headerlink" title="2.2.3 复制算法"></a>2.2.3 复制算法</h3><p><img src="http://image.cryptomartin.top/img/image-20220128224432197.png" srcset="/img/loading.gif" lazyload alt="image-20220128224432197"></p>
<p>复制算法将可用内存按容量分为大小相等的两块，一块叫<code>FROM区域</code>，另一块叫<code>TO区域</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220128225002982.png" srcset="/img/loading.gif" lazyload alt="image-20220128225002982"></p>
<p>复制算法首先也是做标记，把不被<code>GC Root</code>引用的对象标记为垃圾，然后把<code>FROM区域</code>存活的对象赋值到<code>TO区域</code>，复制的过程就会完成碎片的整理，不会产生碎片</p>
<p><img src="http://image.cryptomartin.top/img/image-20220128225113936.png" srcset="/img/loading.gif" lazyload alt="image-20220128225113936"></p>
<p>等复制完成，清空<code>FROM区域</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220128225516448.png" srcset="/img/loading.gif" lazyload alt="image-20220128225516448"></p>
<p>然后交换<code>FROM区域</code>和<code>TO区域</code>的位置，<code>TO区域</code>总是空闲的。</p>
<p><strong>复制算法优缺点</strong></p>
<p>优点</p>
<ul>
<li>不会产生内存碎片</li>
</ul>
<p>缺点</p>
<ul>
<li>占用双倍的内存空间</li>
</ul>
<h3 id="2-2-4-回收算法小结"><a href="#2-2-4-回收算法小结" class="headerlink" title="2.2.4 回收算法小结"></a>2.2.4 回收算法小结</h3><p><strong>标记-清除算法</strong></p>
<p><img src="http://image.cryptomartin.top/img/image-20220128230128163.png" srcset="/img/loading.gif" lazyload alt="image-20220128230128163"></p>
<p><strong>标记-整理算法</strong></p>
<p><img src="http://image.cryptomartin.top/img/image-20220128230147031.png" srcset="/img/loading.gif" lazyload alt="image-20220128230147031"></p>
<p><strong>复制算法</strong></p>
<p><img src="http://image.cryptomartin.top/img/image-20220128230205689.png" srcset="/img/loading.gif" lazyload alt="image-20220128230205689"></p>
<h2 id="2-3-分代垃圾回收"><a href="#2-3-分代垃圾回收" class="headerlink" title="2.3 分代垃圾回收"></a>2.3 分代垃圾回收</h2><h3 id="2-3-1-基本介绍"><a href="#2-3-1-基本介绍" class="headerlink" title="2.3.1 基本介绍"></a>2.3.1 基本介绍</h3><p><img src="http://image.cryptomartin.top/img/image-20220129154032961.png" srcset="/img/loading.gif" lazyload alt="image-20220129154032961"></p>
<p>现在的垃圾收集都采用”分代收集“(Generation Collection)算法。主要思想是根据对象存活周期的不同将内存划分为几块。一般是把Java堆分为<code>新生代</code>和<code>老年代</code>。</p>
<p>新生代又分为3个小的区域，<code>伊甸园</code>，<code>幸存区From</code>，<code>幸存区To</code>。</p>
<p>长时间使用的对象放在老年代中，而那些用完就丢弃的对象放在新生代。</p>
<h3 id="2-3-2-分代回收的基本流程"><a href="#2-3-2-分代回收的基本流程" class="headerlink" title="2.3.2 分代回收的基本流程"></a>2.3.2 分代回收的基本流程</h3><p><img src="http://image.cryptomartin.top/img/image-20220129154854580.png" srcset="/img/loading.gif" lazyload alt="image-20220129154854580"></p>
<p>新的对象被创建，会采用伊甸园的一块空间。当有更多新的对象，它们都在伊甸园中，伊甸园逐渐被沾满了，容纳不下新的对象了，这时就会触发垃圾回收—<code>Minor GC</code>。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220129155832652.png" srcset="/img/loading.gif" lazyload alt="image-20220129155832652"></p>
<p>第一次Minor GC 触发以后，会采用可达性算法，找出有用的对象，标记需要回收的对象进行回收，然后采用复制算法，把存活的对象复制到幸存区To中，会把存活的对象寿命+1(刚开始为0)，交换幸存区From和幸存区To的位置。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220129160754037.png" srcset="/img/loading.gif" lazyload alt="image-20220129160754037"></p>
<p>当Minor GC出发以后，伊甸园空间充足了，又可以在伊甸园创建新的对象。当伊甸园又满了，触发第二次垃圾回收—<code>Minor GC</code>。第二次垃圾回收，不仅要在伊甸园找出存活的对象，还要在幸存区From中找出继续存活的对象(有可能有对象在幸存区时没被引用) 。然后采用复制算法，把存活的对象(包括伊甸园和幸存区From中的对象)复制到幸存区To中，然后象寿命+1，剩下的对象进行回收，交换幸存区From和幸存区To的位置。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220129164910714.png" srcset="/img/loading.gif" lazyload alt="image-20220129164910714"></p>
<p>当幸存区的对象寿命超过阈值(如15)，就晋升到老年代中。有价值的对象逐渐到老年代。<br>当新生代和老年代对象都满了，新对象添加不进去新生代，这时触发了一次老年代垃圾回收—<code>Full GC</code>，做一次整个的清理，从新生代到老年代。</p>
<h3 id="2-3-3-分代回收要点"><a href="#2-3-3-分代回收要点" class="headerlink" title="2.3.3 分代回收要点"></a>2.3.3 分代回收要点</h3><p><img src="http://image.cryptomartin.top/img/image-20220129165020111.png" srcset="/img/loading.gif" lazyload alt="image-20220129165020111"></p>
<ul>
<li>对象首先分配在伊甸园区域</li>
<li>新生代空间不足时，触发 minor gc，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的对象年龄加 1并且交换 from to</li>
<li>minor gc 会引发 stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</li>
<li>当对象寿命超过阈值时，会晋升至老年代，最大寿命是15（4bit）</li>
<li>当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时间更长</li>
</ul>
<h3 id="2-3-4-相关VM参数"><a href="#2-3-4-相关VM参数" class="headerlink" title="2.3.4 相关VM参数"></a>2.3.4 相关VM参数</h3><table>
<thead>
<tr>
<th align="left">含义</th>
<th align="left">参数</th>
</tr>
</thead>
<tbody><tr>
<td align="left">堆初始大小</td>
<td align="left">-Xms</td>
</tr>
<tr>
<td align="left">堆最大大小</td>
<td align="left">-Xmx 或 -XX:MaxHeapSize=size</td>
</tr>
<tr>
<td align="left">新生代大小</td>
<td align="left">-Xmn 或 (-XX:NewSize=size + -XX:MaxNewSize=size )</td>
</tr>
<tr>
<td align="left">幸存区比例(动态)</td>
<td align="left">-XX:InitialSurvivorRatio=ratio 和 -XX:+UseAdaptiveSizePolicy</td>
</tr>
<tr>
<td align="left">幸存区比例</td>
<td align="left">-XX:SurvivorRatio=ratio</td>
</tr>
<tr>
<td align="left">晋升阈值</td>
<td align="left">-XX:MaxTenuringThreshold=threshold</td>
</tr>
<tr>
<td align="left">晋升详情</td>
<td align="left">-XX:+PrintTenuringDistribution</td>
</tr>
<tr>
<td align="left">GC详情</td>
<td align="left">-XX:+PrintGCDetails -verbose:gc</td>
</tr>
<tr>
<td align="left">FullGC 前 MinorGC</td>
<td align="left">-XX:+ScavengeBeforeFullGC</td>
</tr>
</tbody></table>
<h3 id="2-3-5-案例分析GC"><a href="#2-3-5-案例分析GC" class="headerlink" title="2.3.5 案例分析GC"></a>2.3.5 案例分析GC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_1</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _512KB = <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _1MB = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _6MB = <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _7MB = <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _8MB = <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行上面的代码，运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Heap<br> def <span class="hljs-keyword">new</span> generation   total 9216K, used 2190K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  eden space 8192K,  <span class="hljs-number">26</span>% used [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000fee23870</span>, <span class="hljs-number">0x00000000ff400000</span>)<br>  from space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff500000</span>)<br>  to   space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br> tenured generation   total 10240K, used 0K [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>   the space 10240K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600200</span>, <span class="hljs-number">0x0000000100000000</span>)<br> Metaspace       used 3161K, capacity 4496K, committed 4864K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 344<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 388<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>total 9216K</code>:新生代空间为什么只有7MB，我们设置的时10MB？8MB分给伊甸园，另外幸存区From和幸存区To各占1MB，这里认为幸存区To的1MB始终是空的，不能用的。计算空间时不计入幸存区To。</p>
</li>
<li><p><code>[0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000)</code>为内存地址</p>
</li>
<li><p><code> eden space 8192K,  26%</code>:为什么伊甸园一开始有东西了呢？因为再简单的Java程序执行，都需要加载必须的一些类，这些类使用伊甸园的内存空间。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_1</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _512KB = <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _1MB = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _6MB = <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _7MB = <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _8MB = <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ArrayList&lt;<span class="hljs-keyword">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_7MB]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>伊甸园一开始已经有26%的占用了，现在再加入7MB的数组，已经放不下了，这时会触发GC。运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">[GC (Allocation Failure) [DefNew: 2025K-&gt;624K(9216K), <span class="hljs-number">0.0014746</span> secs] 2025K-&gt;624K(19456K), <span class="hljs-number">0.0015406</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>Heap<br> def <span class="hljs-keyword">new</span> generation   total 9216K, used 8202K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  eden space 8192K,  <span class="hljs-number">92</span>% used [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff366830</span>, <span class="hljs-number">0x00000000ff400000</span>)<br>  from space 1024K,  <span class="hljs-number">60</span>% used [<span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff59c208</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  to   space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff500000</span>)<br> tenured generation   total 10240K, used 0K [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>   the space 10240K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600200</span>, <span class="hljs-number">0x0000000100000000</span>)<br> Metaspace       used 3291K, capacity 4496K, committed 4864K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 358<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 388<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br><span class="hljs-class"></span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>DefNew: 2025K-&gt;624K(9216K)</code>:表示GC发生在新生代，9216k是伊甸园的总大小。</li>
<li><code>2025K-&gt;624K(19456K)</code>:整个堆，GC前和GC后的内存占用，19456K是堆的总大小。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_1</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _512KB = <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _1MB = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _6MB = <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _7MB = <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _8MB = <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ArrayList&lt;<span class="hljs-keyword">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_7MB]);<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_512KB]);<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_512KB]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">[GC (Allocation Failure) [DefNew: 1835K-&gt;621K(9216K), <span class="hljs-number">0.0014672</span> secs] 1835K-&gt;621K(19456K), <span class="hljs-number">0.0015383</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>[GC (Allocation Failure) [DefNew: 8628K-&gt;525K(9216K), <span class="hljs-number">0.0070760</span> secs] 8628K-&gt;8292K(19456K), <span class="hljs-number">0.0071476</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] <br>Heap<br> def <span class="hljs-keyword">new</span> generation   total 9216K, used 1203K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  eden space 8192K,   <span class="hljs-number">8</span>% used [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000feca9730</span>, <span class="hljs-number">0x00000000ff400000</span>)<br>  from space 1024K,  <span class="hljs-number">51</span>% used [<span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff4836b0</span>, <span class="hljs-number">0x00000000ff500000</span>)<br>  to   space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br> tenured generation   total 10240K, used 7767K [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>   the space 10240K,  <span class="hljs-number">75</span>% used [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ffd95ca8</span>, <span class="hljs-number">0x00000000ffd95e00</span>, <span class="hljs-number">0x0000000100000000</span>)<br> Metaspace       used 3288K, capacity 4496K, committed 4864K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 357<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 388<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>发生了两次GC，7MB的数组在新生代放不下了，内存紧张，导致提前晋升到老年代。</li>
</ul>
<p><strong>大对象直接晋升到老年代</strong></p>
<p>大对象，不发生GC，直接晋升。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_1</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _512KB = <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _1MB = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _6MB = <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _7MB = <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _8MB = <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ArrayList&lt;<span class="hljs-keyword">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_8MB]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Heap<br> def <span class="hljs-keyword">new</span> generation   total 9216K, used 2190K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  eden space 8192K,  <span class="hljs-number">26</span>% used [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000fee23870</span>, <span class="hljs-number">0x00000000ff400000</span>)<br>  from space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff500000</span>)<br>  to   space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br> tenured generation   total 10240K, used 8192K [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>   the space 10240K,  <span class="hljs-number">80</span>% used [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ffe00010</span>, <span class="hljs-number">0x00000000ffe00200</span>, <span class="hljs-number">0x0000000100000000</span>)<br> Metaspace       used 3288K, capacity 4496K, committed 4864K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 357<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 388<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 512<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>大对象在伊甸园区域容纳不下，不会发生垃圾回收，如果老年代内存空间足够，直接晋升到老年代</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_1</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _512KB = <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _1MB = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _6MB = <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _7MB = <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _8MB = <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            ArrayList&lt;<span class="hljs-keyword">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_8MB]);<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[_8MB]);<br>        &#125;).start();<br><br>        System.out.println(<span class="hljs-string">&quot;main thread...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            Thread.sleep(<span class="hljs-number">1000L</span>);<br>            <span class="hljs-keyword">int</span> j = i;<br>            System.out.println(j);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">main thread...<br>[GC (Allocation Failure) [DefNew: 4093K-&gt;865K(9216K), <span class="hljs-number">0.0032911</span> secs][Tenured: 8192K-&gt;9055K(10240K), <span class="hljs-number">0.0043370</span> secs] 12285K-&gt;9055K(19456K), [Metaspace: 4197K-&gt;4197K(1056768K)], <span class="hljs-number">0.0077406</span> secs] [Times: user=<span class="hljs-number">0.00</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.01</span> secs] <br>[<span class="hljs-function">Full <span class="hljs-title">GC</span> <span class="hljs-params">(Allocation Failure)</span> [Tenured: 9055K-&gt;8999<span class="hljs-title">K</span><span class="hljs-params">(10240K)</span>, 0.0029429 secs] 9055K-&gt;8999<span class="hljs-title">K</span><span class="hljs-params">(19456K)</span>, [Metaspace: 4197K-&gt;4197<span class="hljs-title">K</span><span class="hljs-params">(1056768K)</span>], 0.0030113 secs] [Times: user</span>=<span class="hljs-number">0.02</span> sys=<span class="hljs-number">0.00</span>, real=<span class="hljs-number">0.00</span> secs] <br>Exception in thread <span class="hljs-string">&quot;Thread-0&quot;</span> java.lang.OutOfMemoryError: Java heap space<br>	at com.sunk.jvm.t2.Demo2_1.lambda$main$<span class="hljs-number">0</span>(Demo2_1.java:<span class="hljs-number">20</span>)<br>	at com.sunk.jvm.t2.Demo2_1$$Lambda$<span class="hljs-number">1</span>/<span class="hljs-number">2074407503.</span>run(Unknown Source)<br>	at java.lang.Thread.run(Thread.java:<span class="hljs-number">748</span>)<br><span class="hljs-number">0</span><br><span class="hljs-number">1</span><br><span class="hljs-number">2</span><br><span class="hljs-number">3</span><br><span class="hljs-number">4</span><br>Heap<br> def <span class="hljs-keyword">new</span> generation   total 9216K, used 1539K [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  eden space 8192K,  <span class="hljs-number">18</span>% used [<span class="hljs-number">0x00000000fec00000</span>, <span class="hljs-number">0x00000000fed80c48</span>, <span class="hljs-number">0x00000000ff400000</span>)<br>  from space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff500000</span>, <span class="hljs-number">0x00000000ff600000</span>)<br>  to   space 1024K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff400000</span>, <span class="hljs-number">0x00000000ff500000</span>)<br> tenured generation   total 10240K, used 8999K [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x0000000100000000</span>, <span class="hljs-number">0x0000000100000000</span>)<br>   the space 10240K,  <span class="hljs-number">87</span>% used [<span class="hljs-number">0x00000000ff600000</span>, <span class="hljs-number">0x00000000ffec9d30</span>, <span class="hljs-number">0x00000000ffec9e00</span>, <span class="hljs-number">0x0000000100000000</span>)<br> Metaspace       used 4728K, capacity 4804K, committed 4992K, reserved 1056768K<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">space</span>    <span class="hljs-title">used</span> 526<span class="hljs-title">K</span>, <span class="hljs-title">capacity</span> 560<span class="hljs-title">K</span>, <span class="hljs-title">committed</span> 640<span class="hljs-title">K</span>, <span class="hljs-title">reserved</span> 1048576<span class="hljs-title">K</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>有某个线程发生了内存溢出的错误，并不会影响主线程的运行！</li>
</ul>
<h2 id="2-4-垃圾回收器"><a href="#2-4-垃圾回收器" class="headerlink" title="2.4 垃圾回收器"></a>2.4 垃圾回收器</h2><p>垃圾回收器类型：</p>
<ol>
<li>串行<ul>
<li>单线程，GC发生时会把其他的线程暂停</li>
<li>适用场景：堆内存较小，CPU个数少，适合个人电脑</li>
</ul>
</li>
<li>吞吐量优先<ul>
<li>多线程</li>
<li>适用场景：堆内存较大，多核CPU，服务器</li>
<li>让单位时间内，STW的时间变短(最短) 0.2 0.2 = 0.4</li>
</ul>
</li>
<li>响应时间优先<ul>
<li>多线程</li>
<li>适用场景：堆内存较大，多核CPU，服务器</li>
<li>GC发生时，尽可能让STW的单次时间变短(最短) 0.1 0.1 0.1 0.1 0.1 = 0.5</li>
</ul>
</li>
</ol>
<h3 id="2-4-1-串行垃圾回收器"><a href="#2-4-1-串行垃圾回收器" class="headerlink" title="2.4.1 串行垃圾回收器"></a>2.4.1 串行垃圾回收器</h3><p><code>-XX:+UseSerialGC = Serial + SerialOld</code>，Serial工作在新生代，采用的回收算法是复制算法；SerialOld工作在老年代，采用的回收算法是标记-整理算法。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220130232036389.png" srcset="/img/loading.gif" lazyload alt="image-20220130232036389"></p>
<p>现在有多核CPU，刚开始线程都在运行，过一会儿发现堆内存不够了，发生了GC。触发垃圾回收，会有一个<code>安全点</code>让这些运行的线程都停下来。为什么要让线程停下来？因为垃圾回收的过程中，可能对象的地址发生改变，为了安全地使用对象的地址，需要让所有的线程在安全点暂停下来。这时，进行垃圾回收的工作，就不会有其他的线程来干扰垃圾回收线程。</p>
<p>注意，Serial和SerialOld都是单线程的垃圾回收器，只有一个垃圾回收线程在运行，其他的线程都阻塞，等待垃圾回收线程的结束。当垃圾回收线程的结束，线程都恢复运行。</p>
<h3 id="2-4-2-吞吐量优先垃圾回收器"><a href="#2-4-2-吞吐量优先垃圾回收器" class="headerlink" title="2.4.2 吞吐量优先垃圾回收器"></a>2.4.2 吞吐量优先垃圾回收器</h3><p><code>-XX:+UseParallelGC</code> ~ <code>-XX:+UseParallelOldGC </code></p>
<p><code>-XX:+UseAdaptiveSizePolicy</code></p>
<p><code>-XX:GCTimeRatio=ratio</code> 默认值99 1/(1+99);一般设为19 1/(1+19)=0.05</p>
<p><code>-XX:MaxGCPauseMillis=ms</code> 默认值200ms</p>
<p><code>-XX:ParallelGCThreads=n</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220131135952292.png" srcset="/img/loading.gif" lazyload alt="image-20220131135952292"></p>
<h3 id="2-4-3-响应时间优先"><a href="#2-4-3-响应时间优先" class="headerlink" title="2.4.3 响应时间优先"></a>2.4.3 响应时间优先</h3><p><code>-XX:+UseConcMarkSweepGC</code> ~ <code>-XX:+UseParNewGC</code> ~ <code>SerialOld</code></p>
<p><code>-XX:ParallelGCThreads=n</code> ~ <code>-XX:ConcGCThreads=threads</code> </p>
<p><code>-XX:CMSInitiatingOccupancyFraction=percent</code> 何时执行CMS？</p>
<p><code>-XX:+CMSScavengeBeforeRemark</code> 在重新标记前对新生代进行垃圾回收</p>
<hr>
<p><code>-XX:+UseConcMarkSweepGC</code>:工作在老年代<br>concurrent:并发；paralle:并行<br>并发，指垃圾回收器工作的同时，其他的用户线程也能同时进行，即用户线程和垃圾回收线程并发执行；并发，多个垃圾回收器并行运行，不允许用户线程继续运行。</p>
<p><code>-XX:+UseParNewGC</code>:工作在新生代</p>
<p>当<code>CMS垃圾回收器</code>并发失败时，老年代的垃圾回收器退化为<code>SerialOld</code>,单线程垃圾回收器。</p>
<p><img src="http://image.cryptomartin.top/img/image-20220131140803550.png" srcset="/img/loading.gif" lazyload alt="image-20220131140803550"></p>
<p>多个CPU并行执行，当老年代发生了内存不足，线程都到达安全点暂停下来了。这时，CMS垃圾回收器会做一个初始标记的工作，其他用户线程都暂停下来了，时间非常短；标记完成后，用户线程就可以运行起来了，与此同时，垃圾回收线程继续并发标记，把剩余的垃圾找出来；等并发标记完成，需要STW重新标记，为什么要重新标记？因为垃圾回收线程在并发标记时，用户线程也在同时工作，可能会改变一些对象的引用，会对垃圾回收形成干扰，所以在并发标记完成后，需要做重新标记的工作。等重新标记完成后，用户线程又可以重新运行，垃圾回收线程做并发清理然后运行。</p>
<p>只要在初始标记和重新标记时STW，其他阶段都是并发执行的。</p>
<p><code>-XX:ConcGCThreads=threads</code> 设置为并行线程数的1/4。</p>
<p>CMS垃圾回收器是基于标记清除算法，当老年代内存碎片过多导致内存不足时，发生并发失败，垃圾回收器退为<code>SerialOld</code>垃圾回收器。</p>
<h3 id="2-4-4-G1垃圾回收器-重点"><a href="#2-4-4-G1垃圾回收器-重点" class="headerlink" title="2.4.4 G1垃圾回收器(重点)"></a>2.4.4 G1垃圾回收器(重点)</h3><p>定义：Garbage First</p>
<ul>
<li>2004 论文发布</li>
<li>2009 JDK 6u14 体验</li>
<li>2012 JDK 7u4 官方支持</li>
<li>2017 JDK 9 默认</li>
</ul>
<p>适用场景</p>
<ul>
<li>同时注重吞吐量（Throughput）和低延迟（Low latency），默认的暂停目标是 200 ms</li>
<li>超大堆内存，会将堆划分为多个大小相等的 Region</li>
<li>整体上是 <code>标记+整理</code> 算法，两个区域之间是 <code>复制</code> 算法</li>
</ul>
<p>相关 JVM 参数<br><code>-XX:+UseG1GC</code><br><code>-XX:G1HeapRegionSize=size</code><br><code>-XX:MaxGCPauseMillis=time</code></p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/22591838">Java Hotspot G1 GC的一些关键技术</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV13J411g7A1">【java】垃圾收集器|g1收集器</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP?p=72">满一航P72-P83</a></li>
</ul>
<h2 id="2-5-垃圾回收调优"><a href="#2-5-垃圾回收调优" class="headerlink" title="2.5 垃圾回收调优"></a>2.5 垃圾回收调优</h2><p>预备知识</p>
<ul>
<li>掌握 GC 相关的 VM 参数，会基本的空间调整</li>
<li>掌握相关工具</li>
<li>明白一点：调优跟应用、环境有关，没有放之四海而皆准的法则</li>
</ul>
<h3 id="2-5-1-调优领域"><a href="#2-5-1-调优领域" class="headerlink" title="2.5.1 调优领域"></a>2.5.1 调优领域</h3><ul>
<li>内存</li>
<li>锁竞争</li>
<li>CPU占用</li>
<li>IO</li>
</ul>
<h3 id="2-5-2-确定目标"><a href="#2-5-2-确定目标" class="headerlink" title="2.5.2 确定目标"></a>2.5.2 确定目标</h3><ul>
<li>【低延迟】还是【高吞吐量】，选择合适的回收器</li>
<li>CMS，G1，ZGC</li>
<li>ParallelGC</li>
<li>Zing</li>
</ul>
<h3 id="2-5-3-最快的-GC"><a href="#2-5-3-最快的-GC" class="headerlink" title="2.5.3 最快的 GC"></a>2.5.3 最快的 GC</h3><p>答案是不发生 GC。</p>
<p>查看 FullGC 前后的内存占用，考虑下面几个问题：</p>
<ul>
<li>数据是不是太多？<ul>
<li>resultSet = statement.executeQuery(“select * from 大表 limit n”)</li>
</ul>
</li>
<li>数据表示是否太臃肿？<ul>
<li>对象图 保存不必要的数据内容</li>
<li>对象大小  16 Integer 24 int 4</li>
</ul>
</li>
<li>是否存在内存泄漏？<ul>
<li>static Map map =</li>
<li>软</li>
<li>弱</li>
<li>第三方缓存实现</li>
</ul>
</li>
</ul>
<h3 id="2-5-4-新生代调优"><a href="#2-5-4-新生代调优" class="headerlink" title="2.5.4 新生代调优"></a>2.5.4 新生代调优</h3><p>新生代的特点：</p>
<ul>
<li>所有的 new 操作的内存分配非常廉价<ul>
<li>TLAB thread-local allocation buffer</li>
</ul>
</li>
<li>死亡对象的回收代价是零</li>
<li>大部分对象用过即死</li>
<li>Minor GC 的时间远远低于 Full GC</li>
</ul>
<p>越大越好吗？</p>
<p>-Xmn<br>Sets the initial and maximum size (in bytes) of the heap for the young generation (nursery). GC isperformed in this region more often than in other regions. If the size for the young generation istoo small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete. Oracle recommends that you keep the size for the young generation greater than 25% and less than 50% of the overall heap size.</p>
<p>设置多少合适？</p>
<ul>
<li>新生代能容纳所有【并发量 * (请求-响应)】的数据</li>
<li>幸存区大到能保留【当前活跃对象+需要晋升对象】</li>
<li>晋升阈值配置得当，让长时间存活对象尽快晋升<ul>
<li><code>-XX:MaxTenuringThreshold=threshold</code></li>
<li><code>-XX:+PrintTenuringDistribution </code></li>
</ul>
</li>
</ul>
<h3 id="2-5-5-老年代调优"><a href="#2-5-5-老年代调优" class="headerlink" title="2.5.5 老年代调优"></a>2.5.5 老年代调优</h3><p>以 CMS 为例</p>
<ul>
<li>CMS 的老年代内存越大越好</li>
<li>先尝试不做调优，如果没有 Full GC 那么已经…，否则先尝试调优新生代</li>
<li>观察发生 Full GC 时老年代内存占用，将老年代内存预设调大 1/4 ~ 1/3<ul>
<li><code>-XX:CMSInitiatingOccupancyFraction=percent</code>:控制老年代占总内存的多少时，开始垃圾回收。</li>
</ul>
</li>
</ul>
<h3 id="2-5-6-案例"><a href="#2-5-6-案例" class="headerlink" title="2.5.6 案例"></a>2.5.6 案例</h3><ul>
<li>案例1 Full GC 和 Minor GC频繁<ul>
<li>增大新生代内存，增大幸存区空间和晋升阈值，让生命周期较短的对象尽可能留在新生代。</li>
</ul>
</li>
<li>案例2 请求高峰期发生 Full GC，单次暂停时间特别长 （CMS）<ul>
<li>查看GC日志，重新标记耗时较多，使用<code>-XX:+CMSScavengeBeforeRemark</code> 在重新标记前对新生代进行垃圾回收</li>
</ul>
</li>
<li>案例3 老年代充裕情况下，发生 Full GC （CMS jdk1.7）<ul>
<li>JDK1.7的永久代发生堆的Full GC;JDK1.8改成元空间</li>
</ul>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/JVM/">JVM</a>
                    
                      <a class="hover-with-bg" href="/categories/JVM/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">JVM学习笔记</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/JVM/">JVM</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/02/%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%B7%A5%E5%85%B7/">
                        <span class="hidden-mobile">第八章 共享模型之工具</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
