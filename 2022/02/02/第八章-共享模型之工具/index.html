

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <meta name="description" content="第八章 共享模型之工具本章内容  线程池 J.U.C disruptor guava  8.1  自定义线程池1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677">
<meta property="og:type" content="article">
<meta property="og:title" content="第八章 共享模型之工具">
<meta property="og:url" content="http://example.com/2022/02/02/%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name" content="密鼬CyrptoSkunk">
<meta property="og:description" content="第八章 共享模型之工具本章内容  线程池 J.U.C disruptor guava  8.1  自定义线程池1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220117155441091.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220117155529699.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220117162957144.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220117163306482.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220123171328639.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220123171702762.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220123171712868.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220123171736491.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220123183033090.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220123183829207.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124222445832.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124222701599.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124222733411.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124223513426.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124223648455.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124223708589.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124223744024.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124223820877.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220124223924346.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125111922944.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125112201735.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125112242019.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125112309929.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125112345029.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125112411414.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125112444665.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125161540423.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125161635164.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220125221907757.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162436633.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162523059.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162613412.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162650414.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162807975.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162834085.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162914943.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126162934056.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126164738074.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126164944526.png">
<meta property="og:image" content="http://image.cryptomartin.top/img/image-20220126164952906.png">
<meta property="article:published_time" content="2022-02-01T16:00:16.000Z">
<meta property="article:modified_time" content="2022-02-01T16:01:01.137Z">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="高并发">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://image.cryptomartin.top/img/image-20220117155441091.png">
  
  <title>第八章 共享模型之工具 - 密鼬CyrptoSkunk</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":false,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>密鼬cryptoskunk</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第八章 共享模型之工具">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-02-02 00:00" pubdate>
        2022年2月2日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      57k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      177 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第八章 共享模型之工具</h1>
            
            <div class="markdown-body">
              <h1 id="第八章-共享模型之工具"><a href="#第八章-共享模型之工具" class="headerlink" title="第八章 共享模型之工具"></a>第八章 共享模型之工具</h1><p><strong>本章内容</strong></p>
<ul>
<li>线程池</li>
<li>J.U.C</li>
<li>disruptor</li>
<li>guava</li>
</ul>
<h2 id="8-1-自定义线程池"><a href="#8-1-自定义线程池" class="headerlink" title="8.1  自定义线程池"></a>8.1  自定义线程池</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sunk.test;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><br><span class="hljs-keyword">import</span> java.util.ArrayDeque;<br><span class="hljs-keyword">import</span> java.util.Deque;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> skunk</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j(topic = &quot;c.TestPool&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestPool</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ThreadPool threadPool = <span class="hljs-keyword">new</span> ThreadPool(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS, (queue, task) -&gt; &#123;<br>            <span class="hljs-comment">//1.死等</span><br>            <span class="hljs-comment">//queue.put(task);</span><br>            <span class="hljs-comment">//2.带超时</span><br>            <span class="hljs-comment">//queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span><br>            <span class="hljs-comment">//3.让调用者放弃任务执行</span><br>            <span class="hljs-comment">//log.debug(&quot;放弃&#123;&#125;&quot;, task);</span><br>            <span class="hljs-comment">//4.让调用者抛出异常</span><br>            <span class="hljs-comment">//throw new RuntimeException(&quot;任务执行失败&quot; + task);</span><br>            <span class="hljs-comment">//5.让调用者自己执行任务</span><br>            task.run();<br>        &#125;);<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>            <span class="hljs-keyword">int</span> j = i;<span class="hljs-comment">//i是变化的，赋值给局部变量</span><br>            threadPool.execute(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">1000L</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, j);<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RejectPolicy</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">reject</span><span class="hljs-params">(BlockQueue&lt;T&gt; queue, T task)</span></span>;<br>&#125;<br><br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.ThreadPool&quot;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPool</span> </span>&#123;<br>    <span class="hljs-comment">//任务队列</span><br>    <span class="hljs-keyword">private</span> BlockQueue&lt;Runnable&gt; taskQueue;<br><br>    <span class="hljs-comment">//线程集合</span><br>    <span class="hljs-keyword">private</span> HashSet&lt;worker&gt; workers = <span class="hljs-keyword">new</span> HashSet();<br><br>    <span class="hljs-comment">//核心线程数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> coreSize;<br><br>    <span class="hljs-comment">//超时时间设置</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> timeout;<br>    <span class="hljs-keyword">private</span> TimeUnit timeUnit;<br><br>    <span class="hljs-comment">//拒绝策略</span><br>    <span class="hljs-keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> coreSize, <span class="hljs-keyword">int</span> queueCapacity, <span class="hljs-keyword">long</span> timeout, TimeUnit timeUnit, RejectPolicy&lt;Runnable&gt; rejectPolicy)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.taskQueue = <span class="hljs-keyword">new</span> BlockQueue&lt;&gt;(queueCapacity);<br>        <span class="hljs-keyword">this</span>.coreSize = coreSize;<br>        <span class="hljs-keyword">this</span>.timeout = timeout;<br>        <span class="hljs-keyword">this</span>.timeUnit = timeUnit;<br>        <span class="hljs-keyword">this</span>.rejectPolicy = rejectPolicy;<br>    &#125;<br><br>    <span class="hljs-comment">//分配任务，执行任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable task)</span> </span>&#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        当任务数没有超过coreSize时，直接交给worker对象执行；</span><br><span class="hljs-comment">        当任务数超过coreSize时，加入任务队列</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">synchronized</span> (workers) &#123;<span class="hljs-comment">//为什么要锁住workers?workers是共享资源，HashSet线程不安全。</span><br>            <span class="hljs-keyword">if</span> (workers.size() &lt; coreSize) &#123;<br>                worker worker = <span class="hljs-keyword">new</span> worker(task);<br>                log.debug(<span class="hljs-string">&quot;新增 worker&#123;&#125;,任务&#123;&#125;&quot;</span>, worker, task);<br>                workers.add(worker);<br>                worker.start();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//taskQueue.put(task);</span><br>                <span class="hljs-comment">//拒绝策略</span><br>                taskQueue.tryPut(rejectPolicy, task);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<span class="hljs-comment">//worker是一个线程</span><br>        <span class="hljs-keyword">private</span> Runnable task;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">worker</span><span class="hljs-params">(Runnable task)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.task = task;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            执行任务</span><br><span class="hljs-comment">                1.当task不为空，执行任务；</span><br><span class="hljs-comment">                2.当task执行完毕，再接着从任务队列获取任务并执行</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-comment">//while (task != null || (task = taskQueue.get()) != null) &#123;</span><br>            <span class="hljs-keyword">while</span> (task != <span class="hljs-keyword">null</span> || (task = taskQueue.poll(timeout, timeUnit)) != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;正在执行任务...&#123;&#125;&quot;</span>, task);<br>                    task.run();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    task = <span class="hljs-keyword">null</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">synchronized</span> (workers) &#123;<br>                log.debug(<span class="hljs-string">&quot;worker 被移除&#123;&#125;&quot;</span>, <span class="hljs-keyword">this</span>);<br>                workers.remove(<span class="hljs-keyword">this</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.Blocking&quot;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockQueue</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>    <span class="hljs-comment">//1.任务队列</span><br>    <span class="hljs-keyword">private</span> Deque&lt;T&gt; queue = <span class="hljs-keyword">new</span> ArrayDeque&lt;&gt;();<br><br>    <span class="hljs-comment">//2.锁</span><br>    <span class="hljs-keyword">private</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><br>    <span class="hljs-comment">//3.生产者条件变量</span><br>    <span class="hljs-keyword">private</span> Condition fullWaitSet = lock.newCondition();<br><br>    <span class="hljs-comment">//4.消费者条件变量</span><br>    <span class="hljs-keyword">private</span> Condition emptyWaitSet = lock.newCondition();<br><br>    <span class="hljs-comment">//5.队列容量</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> capacity;<br><br><br>    <span class="hljs-comment">//构造方法</span><br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BlockQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> capacity)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.capacity = capacity;<br>    &#125;<br><br>    <span class="hljs-comment">//消费者获取任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (queue.isEmpty()) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    emptyWaitSet.await();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            T t = queue.removeFirst();<br>            fullWaitSet.signalAll();<br>            <span class="hljs-keyword">return</span> t;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">//消费者带超时的等待</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">poll</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit timeUnit)</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">long</span> nanos = timeUnit.toNanos(timeout);<br>            <span class="hljs-keyword">while</span> (queue.isEmpty()) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                    &#125;<br>                    nanos = emptyWaitSet.awaitNanos(nanos);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            T t = queue.removeFirst();<br>            fullWaitSet.signalAll();<br>            <span class="hljs-keyword">return</span> t;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//生产者产生任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(T task)</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (queue.size() == capacity) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;等待加入任务队列&#123;&#125;...&quot;</span>, task);<br>                    fullWaitSet.await();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            log.debug(<span class="hljs-string">&quot;加入任务队列&#123;&#125;&quot;</span>, task);<br>            queue.addLast(task);<br>            emptyWaitSet.signalAll();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//生产者带超时时间的阻塞添加任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">offer</span><span class="hljs-params">(T task, <span class="hljs-keyword">long</span> timeout, TimeUnit timeUnit)</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">long</span> nanos = timeUnit.toNanos(timeout);<br>            <span class="hljs-keyword">while</span> (queue.size() == capacity) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;等待加入任务队列&#123;&#125;...&quot;</span>, task);<br>                    <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                    &#125;<br>                    nanos = fullWaitSet.awaitNanos(nanos);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            log.debug(<span class="hljs-string">&quot;加入任务队列&#123;&#125;&quot;</span>, task);<br>            queue.addLast(task);<br>            emptyWaitSet.signalAll();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//获取任务队列大小</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> queue.size();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tryPut</span><span class="hljs-params">(RejectPolicy&lt;T&gt; rejectPolicy, T task)</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//判断队列是否已满</span><br>            <span class="hljs-keyword">if</span> (queue.size() == capacity) &#123;<br>                rejectPolicy.reject(<span class="hljs-keyword">this</span>, task);<span class="hljs-comment">//权力下方</span><br><br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//有空闲</span><br>                log.debug(<span class="hljs-string">&quot;加入任务队列&#123;&#125;&quot;</span>, task);<br>                queue.addLast(task);<br>                emptyWaitSet.signalAll();<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="8-2-ThreadPoolExecutor"><a href="#8-2-ThreadPoolExecutor" class="headerlink" title="8.2 ThreadPoolExecutor"></a>8.2 ThreadPoolExecutor</h2><p><img src="http://image.cryptomartin.top/img/image-20220117155441091.png" srcset="/img/loading.gif" lazyload alt="image-20220117155441091"></p>
<h3 id="8-2-1-线程池状态"><a href="#8-2-1-线程池状态" class="headerlink" title="8.2.1 线程池状态"></a>8.2.1 线程池状态</h3><p>ThreadPoolExecutor 使用 int 的高 3 位来表示线程池状态，低 29 位表示线程数量</p>
<p><img src="http://image.cryptomartin.top/img/image-20220117155529699.png" srcset="/img/loading.gif" lazyload alt="image-20220117155529699"></p>
<p>从数字上比较，TERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</p>
<blockquote>
<p>高3位，111– 第一个1表示负数</p>
</blockquote>
<p>这些信息存储在一个原子变量 ctl 中，目的是将线程池状态与线程个数合二为一，这样就可以用一次 cas 原子操作进行赋值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// c 为旧值， ctlOf 返回结果为新值</span><br>ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))));<br><br><span class="hljs-comment">// rs 为高 3 位代表线程池状态， wc 为低 29 位代表线程个数，ctl 是合并它们</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ctlOf</span><span class="hljs-params">(<span class="hljs-keyword">int</span> rs, <span class="hljs-keyword">int</span> wc)</span> </span>&#123; <span class="hljs-keyword">return</span> rs | wc; &#125;<br></code></pre></td></tr></table></figure>



<h3 id="8-2-2-构造方法"><a href="#8-2-2-构造方法" class="headerlink" title="8.2.2 构造方法"></a>8.2.2 构造方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                              <span class="hljs-keyword">int</span> maximumPoolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                              <span class="hljs-keyword">long</span> keepAliveTime,</span></span><br><span class="hljs-params"><span class="hljs-function">                              TimeUnit unit,</span></span><br><span class="hljs-params"><span class="hljs-function">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="hljs-params"><span class="hljs-function">                              RejectedExecutionHandler handler)</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>corePoolSize 核心线程数目 (最多保留的线程数)</li>
<li>maximumPoolSize 最大线程数目</li>
<li>keepAliveTime 生存时间 - 针对救急线程</li>
<li>unit 时间单位 - 针对救急线程</li>
<li>workQueue 阻塞队列</li>
<li>threadFactory 线程工厂 - 可以为线程创建时起个好名字</li>
<li>handler 拒绝策略</li>
</ul>
<p>工作方式：</p>
<p><img src="http://image.cryptomartin.top/img/image-20220117162957144.png" srcset="/img/loading.gif" lazyload alt="image-20220117162957144"></p>
<ul>
<li>线程池中刚开始没有线程，当一个任务提交给线程池后，线程池会创建一个新线程来执行任务。</li>
<li>当线程数达到 corePoolSize 并没有线程空闲，这时再加入任务，新加的任务会被加入workQueue 队列排队，直到有空闲的线程。</li>
<li>如果队列选择了有界队列，那么任务超过了队列大小时，会创建 maximumPoolSize - corePoolSize 数目的线程来救急。</li>
<li>如果线程到达 maximumPoolSize 仍然有新任务这时会执行拒绝策略。拒绝策略 jdk 提供了 4 种实现，其它著名框架也提供了实现<ul>
<li>AbortPolicy 让调用者抛出 RejectedExecutionException 异常，这是默认策略</li>
<li>CallerRunsPolicy 让调用者运行任务</li>
<li>DiscardPolicy 放弃本次任务</li>
<li>DiscardOldestPolicy 放弃队列中最早的任务，本任务取而代之</li>
<li>Dubbo 的实现，在抛出 RejectedExecutionException 异常之前会记录日志，并 dump 线程栈信息，方便定位问题</li>
<li>Netty 的实现，是创建一个新线程来执行任务</li>
<li>ActiveMQ 的实现，带超时等待（60s）尝试放入队列，类似我们之前自定义的拒绝策略</li>
<li>PinPoint 的实现，它使用了一个拒绝策略链，会逐一尝试策略链中每种拒绝策略</li>
</ul>
</li>
<li>当高峰过去后，超过corePoolSize 的救急线程如果一段时间没有任务做，需要结束节省资源，这个时间由keepAliveTime 和 unit 来控制。</li>
</ul>
<p><img src="http://image.cryptomartin.top/img/image-20220117163306482.png" srcset="/img/loading.gif" lazyload alt="image-20220117163306482"></p>
<h3 id="8-2-3-newFixedThreadPool"><a href="#8-2-3-newFixedThreadPool" class="headerlink" title="8.2.3  newFixedThreadPool"></a>8.2.3  newFixedThreadPool</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, ThreadFactory threadFactory)</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,<br>	                                      <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>	                                      <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),<br>	                                      threadFactory);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>特点:</p>
<ul>
<li>核心线程数 == 最大线程数（没有救急线程被创建），因此也无需超时时间</li>
<li>阻塞队列是无界的，可以放任意数量的任务 – LinkedBlockingQueue</li>
</ul>
<blockquote>
<p><strong>评价</strong> 适用于任务量已知，相对耗时的任务</p>
</blockquote>
<p>案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestThreadPoolExecutors&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestThreadPoolExecutors</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ExecutorService pool = Executors.newFixedThreadPool(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> ThreadFactory() &#123;<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicInteger poolNumber = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">1</span>);<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Thread <span class="hljs-title">newThread</span><span class="hljs-params">(Runnable r)</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Thread(r, <span class="hljs-string">&quot;myPool-&quot;</span> + poolNumber.getAndIncrement());<br>            &#125;<br>        &#125;);<br><br>        pool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;1&quot;</span>);<br>        &#125;);<br><br>        pool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;2&quot;</span>);<br>        &#125;);<br><br>        pool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;3&quot;</span>);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="8-2-4-newCachedThreadPool"><a href="#8-2-4-newCachedThreadPool" class="headerlink" title="8.2.4  newCachedThreadPool"></a>8.2.4  newCachedThreadPool</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newCachedThreadPool</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">0</span>, Integer.MAX_VALUE,<br>	 							 <span class="hljs-number">60L</span>, TimeUnit.SECONDS,<br>								 <span class="hljs-keyword">new</span> SynchronousQueue&lt;Runnable&gt;());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>特点：</p>
<ul>
<li>核心线程数是 0， 最大线程数是 Integer.MAX_VALUE，救急线程的空闲生存时间是 60s，意味着<ul>
<li>全部都是救急线程（60s 后可以回收）</li>
<li>救急线程可以无限创建</li>
</ul>
</li>
<li>队列采用了 SynchronousQueue 实现特点是，它没有容量，没有线程来取是放不进去的（一手交钱、一手交货）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestSynchronousQueue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSynchronousQueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SynchronousQueue&lt;Integer&gt; integers = <span class="hljs-keyword">new</span> SynchronousQueue&lt;&gt;();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;putting &#123;&#125; &quot;</span>, <span class="hljs-number">1</span>);<br>                integers.put(<span class="hljs-number">1</span>);<br>                log.debug(<span class="hljs-string">&quot;&#123;&#125; putted...&quot;</span>, <span class="hljs-number">1</span>);<br>                log.debug(<span class="hljs-string">&quot;putting...&#123;&#125; &quot;</span>, <span class="hljs-number">2</span>);<br>                integers.put(<span class="hljs-number">2</span>);<br>                log.debug(<span class="hljs-string">&quot;&#123;&#125; putted...&quot;</span>, <span class="hljs-number">2</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;taking &#123;&#125;&quot;</span>, <span class="hljs-number">1</span>);<br>                integers.take();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>        <br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;taking &#123;&#125;&quot;</span>, <span class="hljs-number">2</span>);<br>                integers.take();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t3&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">23</span>:<span class="hljs-number">24</span>:09 [t1] c.TestSynchronousQueue - putting <span class="hljs-number">1</span> <br><span class="hljs-number">23</span>:<span class="hljs-number">24</span>:<span class="hljs-number">10</span> [t2] c.TestSynchronousQueue - taking <span class="hljs-number">1</span><br><span class="hljs-number">23</span>:<span class="hljs-number">24</span>:<span class="hljs-number">10</span> [t1] c.TestSynchronousQueue - <span class="hljs-number">1</span> putted...<br><span class="hljs-number">23</span>:<span class="hljs-number">24</span>:<span class="hljs-number">10</span> [t1] c.TestSynchronousQueue - putting..<span class="hljs-number">.2</span> <br><span class="hljs-number">23</span>:<span class="hljs-number">24</span>:<span class="hljs-number">11</span> [t3] c.TestSynchronousQueue - taking <span class="hljs-number">2</span><br><span class="hljs-number">23</span>:<span class="hljs-number">24</span>:<span class="hljs-number">11</span> [t1] c.TestSynchronousQueue - <span class="hljs-number">2</span> putted...<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>评价</strong> 整个线程池表现为线程数会根据任务量不断增长，没有上限，当任务执行完毕，空闲 1分钟后释放线程。 适合任务数比较密集，但每个任务执行时间较短的情况</p>
</blockquote>
<h3 id="8-2-5-newSingleThreadExecuto"><a href="#8-2-5-newSingleThreadExecuto" class="headerlink" title="8.2.5 newSingleThreadExecuto"></a>8.2.5 newSingleThreadExecuto</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FinalizableDelegatedExecutorService<br>	 (<span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>,<br>	 <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>	 <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用场景：</p>
<p>希望多个任务排队执行。线程数固定为 1，任务数多于 1 时，会放入无界队列排队。任务执行完毕，这唯一的线程也不会被释放。</p>
<p>区别：</p>
<ul>
<li>自己创建一个单线程串行执行任务，如果任务执行失败而终止那么没有任何补救措施，而线程池还会新建一个线程，保证池的正常工作。</li>
<li>Executors.newSingleThreadExecutor() 线程个数始终为1，不能修改<ul>
<li>FinalizableDelegatedExecutorService 应用的是装饰器模式，只对外暴露了 ExecutorService 接口，因此不能调用 ThreadPoolExecutor 中特有的方法</li>
</ul>
</li>
<li>Executors.newFixedThreadPool(1) 初始时为1，以后还可以修改<ul>
<li>对外暴露的是 ThreadPoolExecutor 对象，可以强转后调用 setCorePoolSize 等方法进行修改</li>
</ul>
</li>
</ul>
<h3 id="8-2-6-提交任务"><a href="#8-2-6-提交任务" class="headerlink" title="8.2.6 提交任务"></a>8.2.6 提交任务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 执行任务</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable command)</span></span>;<br><br><span class="hljs-comment">// 提交任务 task，用返回值 Future 获得任务执行结果</span><br>&lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span></span>;<br><br><span class="hljs-comment">// 提交 tasks 中所有任务</span><br>&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) <span class="hljs-keyword">throws</span> InterruptedException;<br><br><span class="hljs-comment">// 提交 tasks 中所有任务，带超时时间</span><br>&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,<span class="hljs-keyword">long</span> timeout, TimeUnit unit) <span class="hljs-keyword">throws</span> InterruptedException;<br><br><span class="hljs-comment">// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消</span><br>&lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="hljs-function"> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException</span>;<br><br><span class="hljs-comment">// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消，带超时时间</span><br>&lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span><span class="hljs-keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;<br></code></pre></td></tr></table></figure>



<p><code>submit</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestSubmit&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSubmit</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>        ExecutorService threadPool = Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>        Future&lt;String&gt; future = threadPool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;running&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>        &#125;);<br><br>        log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, future.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><code>invokeAll</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>	ExecutorService threadPool = Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>	List&lt;Future&lt;Object&gt;&gt; futures = threadPool.invokeAll(Arrays.asList(<br>	                () -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;1&quot;</span>);<br>		Thread.sleep(<span class="hljs-number">1000</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>	&#125;<br>	,<br>	                () -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;2&quot;</span>);<br>		Thread.sleep(<span class="hljs-number">500</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2&quot;</span>;<br>	&#125;<br>	,<br>	                () -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;3&quot;</span>);<br>		Thread.sleep(<span class="hljs-number">2000</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;3&quot;</span>;<br>	&#125;<br>	));<br>	futures.forEach(f -&gt; &#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, f.get());<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>	&#125;<br>	);<br>&#125;<br></code></pre></td></tr></table></figure>



<p><code>invokeAny</code>返回最先得到的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>    ExecutorService threadPool = Executors.newFixedThreadPool(<span class="hljs-number">1</span>);<br>    String result = threadPool.invokeAny(Arrays.asList(<br>            () -&gt; &#123;<br>                log.debug(<span class="hljs-string">&quot;begin 1&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                log.debug(<span class="hljs-string">&quot;end 1&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>            &#125;,<br>            () -&gt; &#123;<br>                log.debug(<span class="hljs-string">&quot;begin 2&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">500</span>);<br>                log.debug(<span class="hljs-string">&quot;end 2&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2&quot;</span>;<br>            &#125;,<br>            () -&gt; &#123;<br>                log.debug(<span class="hljs-string">&quot;begin 3&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>                log.debug(<span class="hljs-string">&quot;end 3&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;3&quot;</span>;<br>            &#125;<br>    ));<br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, result);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="8-2-7-关闭线程池"><a href="#8-2-7-关闭线程池" class="headerlink" title="8.2.7 关闭线程池"></a>8.2.7 关闭线程池</h3><p><strong>shutdown</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">线程池状态变为 SHUTDOWN</span><br><span class="hljs-comment">- 不会接收新任务</span><br><span class="hljs-comment">- 但已提交任务会执行完</span><br><span class="hljs-comment">- 此方法不会阻塞调用线程的执行</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span></span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;<br>	mainLock.lock();<br>	<span class="hljs-keyword">try</span> &#123;<br>		checkShutdownAccess();<br>		<span class="hljs-comment">// 修改线程池状态</span><br>		advanceRunState(SHUTDOWN);<br>		<span class="hljs-comment">// 仅会打断空闲线程</span><br>		interruptIdleWorkers();<br>		onShutdown();<br>		<span class="hljs-comment">// 扩展点 ScheduledThreadPoolExecutor</span><br>	&#125;<br>	<span class="hljs-keyword">finally</span> &#123;<br>		mainLock.unlock();<br>	&#125;<br>	<span class="hljs-comment">// 尝试终结(没有运行的线程可以立刻终结，如果还有运行的线程也不会等)</span><br>	tryTerminate();<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>shutdownNow</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">线程池状态变为 STOP</span><br><span class="hljs-comment">- 不会接收新任务</span><br><span class="hljs-comment">- 会将队列中的任务返回</span><br><span class="hljs-comment">- 并用 interrupt 的方式中断正在执行的任务</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function">List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span></span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span> </span>&#123;<br>	List&lt;Runnable&gt; tasks;<br>	<span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;<br>	mainLock.lock();<br>	<span class="hljs-keyword">try</span> &#123;<br>		checkShutdownAccess();<br>		<span class="hljs-comment">// 修改线程池状态</span><br>		advanceRunState(STOP);<br>		<span class="hljs-comment">// 打断所有线程</span><br>		interruptWorkers();<br>		<span class="hljs-comment">// 获取队列中剩余任务</span><br>		tasks = drainQueue();<br>	&#125;<br>	<span class="hljs-keyword">finally</span> &#123;<br>		mainLock.unlock();<br>	&#125;<br>	<span class="hljs-comment">// 尝试终结</span><br>	tryTerminate();<br>	<span class="hljs-keyword">return</span> tasks;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>其他方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 不在 RUNNING 状态的线程池，此方法就返回 true</span><br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isShutdown</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-comment">// 线程池状态是否是 TERMINATED</span><br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isTerminated</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-comment">// 调用 shutdown 后，由于调用线程并不会等待所有任务运行结束，因此如果它想在线程池 TERMINATED 后做些事情，可以利用此方法等待</span><br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitTermination</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;<br></code></pre></td></tr></table></figure>



<p><strong>案例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestShutDown&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestShutDown</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span>  </span>&#123;<br>        ExecutorService pool = Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br><br>        Future&lt;Integer&gt; result1 = pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;task 1 running...&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 1 finish...&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;);<br><br>        Future&lt;Integer&gt; result2 = pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;task 2 running...&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 2 finish...&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>        &#125;);<br><br>        Future&lt;Integer&gt; result3 = pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;task 3 running...&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 3 finish...&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>        &#125;);<br><br>        pool.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用<code>shutdown</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">55</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">1</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">55</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">2</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">56</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">2</span> finish...<br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">56</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">1</span> finish...<br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">56</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">3</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">13</span>:<span class="hljs-number">57</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">3</span> finish...<br></code></pre></td></tr></table></figure>

<blockquote>
<p>3个任务都执行完成</p>
</blockquote>
<p>调用<code>awaitTermination</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">log.debug(<span class="hljs-string">&quot;shutdown&quot;</span>);<br>pool.shutdown();<br>pool.awaitTermination(<span class="hljs-number">3</span>, TimeUnit.SECONDS);<br>log.debug(<span class="hljs-string">&quot;other...&quot;</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">32</span> [main] c.TestShutDown - shutdown<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">32</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">1</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">32</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">2</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">33</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">1</span> finish...<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">33</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">2</span> finish...<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">33</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">3</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">34</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">3</span> finish...<br><span class="hljs-number">11</span>:<span class="hljs-number">16</span>:<span class="hljs-number">34</span> [main] c.TestShutDown - other...<br></code></pre></td></tr></table></figure>

<blockquote>
<p>调用 shutdown 后,调用awaitTermination进行等待；如果线程都执行完成，则无需等待。</p>
</blockquote>
<p>调用<code>shutdownNow()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">        log.debug(<span class="hljs-string">&quot;shutdown&quot;</span>);<br><span class="hljs-comment">//        pool.shutdown();</span><br><span class="hljs-comment">//        pool.awaitTermination(3, TimeUnit.SECONDS);</span><br>        List&lt;Runnable&gt; burnables = pool.shutdownNow();<br>        log.debug(<span class="hljs-string">&quot;other...&#123;&#125;&quot;</span>,burnables);<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">12</span> [main] c.TestShutDown - shutdown<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] c.TestShutDown - task <span class="hljs-number">2</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestShutDown - task <span class="hljs-number">1</span> running...<br><span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">12</span> [main] c.TestShutDown - other...[java.util.concurrent.FutureTask@2b80d80f]<br></code></pre></td></tr></table></figure>

<blockquote>
<p>正在执行的任务，还是任务队列中的任务都进行打断。返回一个任务list</p>
</blockquote>
<h2 id="8-3-【模式】异步模式之工作线程"><a href="#8-3-【模式】异步模式之工作线程" class="headerlink" title="8.3 【模式】异步模式之工作线程"></a>8.3 【模式】异步模式之工作线程</h2><h3 id="8-3-1-定义"><a href="#8-3-1-定义" class="headerlink" title="8.3.1 定义"></a>8.3.1 定义</h3><p>让有限的工作线程（Worker Thread）来轮流异步处理无限多的任务。也可以将其归类为分工模式，它的典型实现就是线程池，也体现了经典设计模式中的享元模式。</p>
<p>例如，海底捞的服务员（线程），轮流处理每位客人的点餐（任务），如果为每位客人都配一名专属的服务员，那么成本就太高了（对比另一种多线程设计模式：Thread-Per-Message）</p>
<p>注意，不同任务类型应该使用不同的线程池，这样能够避免饥饿，并能提升效率<br>例如，如果一个餐馆的工人既要招呼客人（任务类型A），又要到后厨做菜（任务类型B）显然效率不咋地，分成服务员（线程池A）与厨师（线程池B）更为合理，当然你能想到更细致的分工</p>
<h3 id="8-3-2-饥饿"><a href="#8-3-2-饥饿" class="headerlink" title="8.3.2 饥饿"></a>8.3.2 饥饿</h3><p>固定大小线程池会有饥饿现象</p>
<ul>
<li>两个工人是同一个线程池中的两个线程</li>
<li>他们要做的事情是：为客人点餐和到后厨做菜，这是两个阶段的工作<ul>
<li>客人点餐：必须先点完餐，等菜做好，上菜，在此期间处理点餐的工人必须等待</li>
<li>后厨做菜：没啥说的，做就是了</li>
</ul>
</li>
<li>比如工人A 处理了点餐任务，接下来它要等着 工人B 把菜做好，然后上菜，他俩也配合的蛮好</li>
<li>但现在同时来了两个客人，这个时候工人A 和工人B 都去处理点餐了，这时没人做饭了，饥饿</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestStarvation&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestStarvation</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="hljs-string">&quot;地三鲜&quot;</span>, <span class="hljs-string">&quot;宫保鸡丁&quot;</span>, <span class="hljs-string">&quot;辣子鸡丁&quot;</span>, <span class="hljs-string">&quot;烤鸡翅&quot;</span>);<br>    <span class="hljs-keyword">static</span> Random RANDOM = <span class="hljs-keyword">new</span> Random();<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">cooking</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ExecutorService waiterPool = Executors.newFixedThreadPool(<span class="hljs-number">1</span>);<br>        ExecutorService cookPool = Executors.newFixedThreadPool(<span class="hljs-number">1</span>);<br><br>        waiterPool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;处理点餐...&quot;</span>);<br>            Future&lt;String&gt; f = cookPool.submit(() -&gt; &#123;<br>                log.debug(<span class="hljs-string">&quot;做菜&quot;</span>);<br>                <span class="hljs-keyword">return</span> cooking();<br>            &#125;);<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;上菜: &#123;&#125;&quot;</span>, f.get());<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br>        waiterPool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;处理点餐...&quot;</span>);<br>            Future&lt;String&gt; f = cookPool.submit(() -&gt; &#123;<br>                log.debug(<span class="hljs-string">&quot;做菜&quot;</span>);<br>                <span class="hljs-keyword">return</span> cooking();<br>            &#125;);<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;上菜: &#123;&#125;&quot;</span>, f.get());<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">18</span>:<span class="hljs-number">32</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestStarvation - 处理点餐...<br><span class="hljs-number">18</span>:<span class="hljs-number">32</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">1</span>] c.TestStarvation - 做菜<br><span class="hljs-number">18</span>:<span class="hljs-number">32</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestStarvation - 上菜: 辣子鸡丁<br><span class="hljs-number">18</span>:<span class="hljs-number">32</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestStarvation - 处理点餐...<br><span class="hljs-number">18</span>:<span class="hljs-number">32</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">1</span>] c.TestStarvation - 做菜<br><span class="hljs-number">18</span>:<span class="hljs-number">32</span>:<span class="hljs-number">12</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] c.TestStarvation - 上菜: 地三鲜<br></code></pre></td></tr></table></figure>



<h3 id="8-3-3-创建多少线程合适"><a href="#8-3-3-创建多少线程合适" class="headerlink" title="8.3.3 创建多少线程合适"></a>8.3.3 创建多少线程合适</h3><ul>
<li>过小会导致程序不能充分地利用系统资源、容易导致饥饿</li>
<li>过大会导致更多的线程上下文切换，占用更多内存</li>
</ul>
<p><strong>CPU 密集型运算</strong></p>
<p>通常采用 <code>cpu 核数 + 1</code> 能够实现最优的 CPU 利用率，+1 是保证当线程由于页缺失故障（操作系统）或其它原因导致暂停时，额外的这个线程就能顶上去，保证 CPU 时钟周期不被浪费</p>
<p><strong>I/O 密集型运算</strong></p>
<p>CPU 不总是处于繁忙状态，例如，当你执行业务计算时，这时候会使用 CPU 资源，但当你执行 I/O 操作时、远程<br>RPC 调用时，包括进行数据库操作时，这时候 CPU 就闲下来了，你可以利用多线程提高它的利用率。</p>
<p>经验公式如下:<br><code>线程数 = 核数 * 期望 CPU 利用率 * 总时间(CPU计算时间+等待时间) / CPU 计算时间</code></p>
<p>例如 4 核 CPU 计算时间是 50% ，其它等待时间是 50%，期望 cpu 被 100% 利用，套用公式</p>
<p><code>4 * 100% * 100% / 50% = 8</code></p>
<p>例如 4 核 CPU 计算时间是 10% ，其它等待时间是 90%，期望 cpu 被 100% 利用，套用公式</p>
<p><code>4 * 100% * 100% / 10% = 40</code></p>
<h2 id="8-4-任务调度线程池"><a href="#8-4-任务调度线程池" class="headerlink" title="8.4 任务调度线程池"></a>8.4 任务调度线程池</h2><h3 id="8-4-1newScheduledThreadPool"><a href="#8-4-1newScheduledThreadPool" class="headerlink" title="8.4.1newScheduledThreadPool"></a>8.4.1newScheduledThreadPool</h3><p>在『任务调度线程池』功能加入之前，可以使用 java.util.Timer 来实现定时功能，Timer 的优点在于简单易用，但由于所有任务都是由同一个线程来调度，因此所有任务都是串行执行的，同一时间只能有一个任务在执行，前一个任务的延迟或异常都将会影响到之后的任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>	Timer timer = <span class="hljs-keyword">new</span> Timer();<br>	TimerTask task1 = <span class="hljs-keyword">new</span> TimerTask() &#123;<br>		<span class="hljs-meta">@Override</span><br>		 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>			log.debug(<span class="hljs-string">&quot;task 1&quot;</span>);<br>			sleep(<span class="hljs-number">2</span>);<br>		&#125;<br>	&#125;<br>	;<br>	TimerTask task2 = <span class="hljs-keyword">new</span> TimerTask() &#123;<br>		<span class="hljs-meta">@Override</span><br>		 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>			log.debug(<span class="hljs-string">&quot;task 2&quot;</span>);<br>		&#125;<br>	&#125;<br>	;<br>	<span class="hljs-comment">// 使用 timer 添加两个任务，希望它们都在 1s 后执行</span><br>	<span class="hljs-comment">// 但由于 timer 内只有一个线程来顺序执行队列中的任务，因此『任务1』的延时，影响了『任务2』的执行</span><br>	timer.schedule(task1, <span class="hljs-number">1000</span>);<br>	timer.schedule(task2, <span class="hljs-number">1000</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用 ScheduledExecutorService 改写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);<br>pool.schedule(() -&gt; &#123;<br>	log.debug(<span class="hljs-string">&quot;task1&quot;</span>);<br>	<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>&#125;, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br><br>pool.schedule(() -&gt; &#123;<br>	log.debug(<span class="hljs-string">&quot;task2&quot;</span>);<br>&#125;, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>



<p>scheduleAtFixedRate 例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">ScheduledExecutorService pool = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);<br>log.debug(<span class="hljs-string">&quot;start...&quot;</span>);<br>pool.scheduleAtFixedRate(() -&gt; &#123;<br>	log.debug(<span class="hljs-string">&quot;running...&quot;</span>);<br>&#125;, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>



<p>scheduleWithFixedDelay 例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">ScheduledExecutorService pool = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);<br>log.debug(<span class="hljs-string">&quot;start...&quot;</span>);<br>pool.scheduleWithFixedDelay(()-&gt; &#123;<br> log.debug(<span class="hljs-string">&quot;running...&quot;</span>);<br> sleep(<span class="hljs-number">2</span>);<br>&#125;, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>

<p>输出分析：一开始，延时 1s，scheduleWithFixedDelay 的间隔是 上一个任务结束 &lt;-&gt; 延时 &lt;-&gt; 下一个任务开始 所以间隔都是 3s</p>
<blockquote>
<p><strong>评价</strong> 整个线程池表现为：线程数固定，任务数多于线程数时，会放入无界队列排队。任务执行完毕，这些线程也不会被释放。用来执行延迟或反复执行的任务</p>
</blockquote>
<h3 id="8-4-2-正确处理执行任务异常"><a href="#8-4-2-正确处理执行任务异常" class="headerlink" title="8.4.2 正确处理执行任务异常"></a>8.4.2 正确处理执行任务异常</h3><p><strong>方法1：主动捉异常</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">ExecutorService pool = Executors.newFixedThreadPool(<span class="hljs-number">1</span>);<br>pool.submit(() -&gt; &#123;<br> <span class="hljs-keyword">try</span> &#123;<br> log.debug(<span class="hljs-string">&quot;task1&quot;</span>);<br> <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br> &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br> log.error(<span class="hljs-string">&quot;error:&quot;</span>, e);<br> &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<p><strong>方法2：被动处理-使用 Future</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">ExecutorService pool = Executors.newFixedThreadPool(<span class="hljs-number">1</span>);<br>Future&lt;Boolean&gt; f = pool.submit(() -&gt; &#123;<br> log.debug(<span class="hljs-string">&quot;task1&quot;</span>);<br> <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>&#125;);<br>log.debug(<span class="hljs-string">&quot;result:&#123;&#125;&quot;</span>, f.get());<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">21</span>:<span class="hljs-number">54</span>:<span class="hljs-number">58.208</span> c.TestTimer [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] - task1 <br>Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.util.concurrent.ExecutionException: <br>java.lang.ArithmeticException: / by zero <br> at java.util.concurrent.FutureTask.report(FutureTask.java:<span class="hljs-number">122</span>) <br> at java.util.concurrent.FutureTask.get(FutureTask.java:<span class="hljs-number">192</span>) <br> at cn.itcast.n8.TestTimer.main(TestTimer.java:<span class="hljs-number">31</span>) <br>Caused by: java.lang.ArithmeticException: / by zero <br> at cn.itcast.n8.TestTimer.lambda$main$<span class="hljs-number">0</span>(TestTimer.java:<span class="hljs-number">28</span>) <br> at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="hljs-number">266</span>) <br> at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="hljs-number">1149</span>) <br> at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="hljs-number">624</span>) <br> at java.lang.Thread.run(Thread.java:<span class="hljs-number">748</span>)<br></code></pre></td></tr></table></figure>

<h3 id="8-4-3-任务调度线程池的应用-定时任务"><a href="#8-4-3-任务调度线程池的应用-定时任务" class="headerlink" title="8.4.3 任务调度线程池的应用-定时任务"></a>8.4.3 任务调度线程池的应用-定时任务</h3><p>如何让每周四 18:00:00 定时执行任务？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获得当前时间</span><br>LocalDateTime now = LocalDateTime.now();<br><span class="hljs-comment">// 获取本周四 18:00:00.000</span><br>LocalDateTime thursday = now.with(DayOfWeek.THURSDAY).withHour(<span class="hljs-number">18</span>).withMinute(<span class="hljs-number">0</span>).withSecond(<span class="hljs-number">0</span>).withNano(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// 如果当前时间已经超过 本周四 18:00:00.000， 那么找下周四 18:00:00.000</span><br><span class="hljs-keyword">if</span>(now.compareTo(thursday) &gt;= <span class="hljs-number">0</span>) &#123;<br>	thursday = thursday.plusWeeks(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">// 计算时间差，即延时执行时间</span><br><span class="hljs-keyword">long</span> initialDelay = Duration.between(now, thursday).toMillis();<br><span class="hljs-comment">// 计算间隔时间，即 1 周的毫秒值</span><br><span class="hljs-keyword">long</span> oneWeek = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>;<br>ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);<br>System.out.println(<span class="hljs-string">&quot;开始时间：&quot;</span> + <span class="hljs-keyword">new</span> Date());<br>executor.scheduleAtFixedRate(() -&gt; &#123;<br>	System.out.println(<span class="hljs-string">&quot;执行时间：&quot;</span> + <span class="hljs-keyword">new</span> Date());<br>&#125;, initialDelay, oneWeek, TimeUnit.MILLISECONDS);<br></code></pre></td></tr></table></figure>



<h3 id="8-4-4-Tomcat线程池"><a href="#8-4-4-Tomcat线程池" class="headerlink" title="8.4.4 Tomcat线程池"></a>8.4.4 Tomcat线程池</h3><p>Tomcat 在哪里用到了线程池呢</p>
<p><img src="http://image.cryptomartin.top/img/image-20220123171328639.png" srcset="/img/loading.gif" lazyload alt="image-20220123171328639"></p>
<ul>
<li>LimitLatch 用来限流，可以控制最大连接个数，类似 J.U.C 中的 Semaphore 后面再讲</li>
<li>Acceptor 只负责【接收新的 socket 连接】</li>
<li>Poller 只负责监听 socket channel 是否有【可读的 I/O 事件】</li>
<li>一旦可读，封装一个任务对象（socketProcessor），提交给 Executor 线程池处理</li>
<li>Executor 线程池中的工作线程最终负责【处理请求】</li>
</ul>
<p>Tomcat 线程池扩展了 ThreadPoolExecutor，行为稍有不同</p>
<ul>
<li>如果总线程数达到 maximumPoolSize<br>这时不会立刻抛 RejectedExecutionException 异常<br>而是再次尝试将任务放入队列，如果还失败，才抛出 RejectedExecutionException 异常</li>
</ul>
<p>源码 tomcat-7.0.42</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable command, <span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;<br>	submittedCount.incrementAndGet();<br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-keyword">super</span>.execute(command);<br>	&#125;<span class="hljs-keyword">catch</span> (RejectedExecutionException rx) &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">super</span>.getQueue() <span class="hljs-keyword">instanceof</span> TaskQueue) &#123;<br>			<span class="hljs-keyword">final</span> TaskQueue queue = (TaskQueue)<span class="hljs-keyword">super</span>.getQueue();<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-keyword">if</span> (!queue.force(command, timeout, unit)) &#123;<br>					submittedCount.decrementAndGet();<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RejectedExecutionException(<span class="hljs-string">&quot;Queue capacity is full.&quot;</span>);<br>				&#125;<br>			&#125;<span class="hljs-keyword">catch</span> (InterruptedException x) &#123;<br>				submittedCount.decrementAndGet();<br>				Thread.interrupted();<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RejectedExecutionException(x);<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			submittedCount.decrementAndGet();<br>			<span class="hljs-keyword">throw</span> rx;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TaskQueue.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">force</span><span class="hljs-params">(Runnable o, <span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>	<span class="hljs-keyword">if</span> ( parent.isShutdown() ) <br>	 <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RejectedExecutionException(<br>	 <span class="hljs-string">&quot;Executor not running, can&#x27;t force a command into the queue&quot;</span><br>	 );<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.offer(o,timeout,unit);<br>	<span class="hljs-comment">//forces the item onto the queue, to be used if the task </span><br>	is rejected<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="http://image.cryptomartin.top/img/image-20220123171702762.png" srcset="/img/loading.gif" lazyload alt="image-20220123171702762"></p>
<p>Executor配置</p>
<p><img src="http://image.cryptomartin.top/img/image-20220123171712868.png" srcset="/img/loading.gif" lazyload alt="image-20220123171712868"></p>
<p><img src="http://image.cryptomartin.top/img/image-20220123171736491.png" srcset="/img/loading.gif" lazyload alt="image-20220123171736491"></p>
<blockquote>
<p>Tomcat 达到最大核心线程数时，先创建救急线程。</p>
</blockquote>
<h2 id="8-5-Fork-Join"><a href="#8-5-Fork-Join" class="headerlink" title="8.5 Fork/Join"></a>8.5 Fork/Join</h2><h3 id="8-5-1-概念"><a href="#8-5-1-概念" class="headerlink" title="8.5.1 概念"></a>8.5.1 概念</h3><p>Fork/Join 是 JDK 1.7 加入的新的线程池实现，它体现的是一种分治思想，适用于能够进行任务拆分的 cpu 密集型运算</p>
<p>所谓的任务拆分，是将一个大任务拆分为算法上相同的小任务，直至不能拆分可以直接求解。跟递归相关的一些计算，如归并排序、斐波那契数列、都可以用分治思想进行求解</p>
<p>Fork/Join 在分治的基础上加入了多线程，可以把每个任务的分解和合并交给不同的线程来完成，进一步提升了运算效率</p>
<p>Fork/Join 默认会创建与 cpu 核心数大小相同的线程池</p>
<h3 id="8-5-2-使用"><a href="#8-5-2-使用" class="headerlink" title="8.5.2 使用"></a>8.5.2 使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestForkJoin&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestForkJoin</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ForkJoinPool pool = <span class="hljs-keyword">new</span> ForkJoinPool();<br>        System.out.println(pool.invoke(<span class="hljs-keyword">new</span> MyTask(<span class="hljs-number">5</span>)));<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//计算1~n的累加</span><br><span class="hljs-meta">@Slf4j(topic = &quot;c.MyTask&quot;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecursiveTask</span>&lt;<span class="hljs-title">Integer</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> n;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyTask</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.n = n;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&quot;</span> + n + <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Integer <span class="hljs-title">compute</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 如果 n 已经为 1，可以求得结果了</span><br>        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) &#123;<br>            log.debug(<span class="hljs-string">&quot;join() &#123;&#125;&quot;</span>, n);<br>            <span class="hljs-keyword">return</span> n;<br>        &#125;<br><br>        <span class="hljs-comment">// 将任务进行拆分(fork)</span><br>        MyTask t1 = <span class="hljs-keyword">new</span> MyTask(n - <span class="hljs-number">1</span>);<br>        t1.fork();<br>        log.debug(<span class="hljs-string">&quot;fork() &#123;&#125; + &#123;&#125;&quot;</span>, n, t1);<br><br>        <span class="hljs-comment">// 合并(join)结果</span><br>        <span class="hljs-keyword">int</span> result = n + t1.join();<br>        log.debug(<span class="hljs-string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, n, t1, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">2</span>] c.MyTask - fork() <span class="hljs-number">4</span> + &#123;<span class="hljs-number">3</span>&#125;<br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">1</span>] c.MyTask - fork() <span class="hljs-number">5</span> + &#123;<span class="hljs-number">4</span>&#125;<br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">5</span>] c.MyTask - join() <span class="hljs-number">1</span><br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">3</span>] c.MyTask - fork() <span class="hljs-number">3</span> + &#123;<span class="hljs-number">2</span>&#125;<br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">4</span>] c.MyTask - fork() <span class="hljs-number">2</span> + &#123;<span class="hljs-number">1</span>&#125;<br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">4</span>] c.MyTask - join() <span class="hljs-number">2</span> + &#123;<span class="hljs-number">1</span>&#125; = <span class="hljs-number">3</span><br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">3</span>] c.MyTask - join() <span class="hljs-number">3</span> + &#123;<span class="hljs-number">2</span>&#125; = <span class="hljs-number">6</span><br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">2</span>] c.MyTask - join() <span class="hljs-number">4</span> + &#123;<span class="hljs-number">3</span>&#125; = <span class="hljs-number">10</span><br><span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">1</span>] c.MyTask - join() <span class="hljs-number">5</span> + &#123;<span class="hljs-number">4</span>&#125; = <span class="hljs-number">15</span><br></code></pre></td></tr></table></figure>

<p><img src="http://image.cryptomartin.top/img/image-20220123183033090.png" srcset="/img/loading.gif" lazyload alt="image-20220123183033090"></p>
<p>串行执行，并行度不高。进行改进</p>
<p><strong>改进</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//二分法计算1~n的累加</span><br><span class="hljs-meta">@Slf4j(topic = &quot;c.MyTask2&quot;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTask2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecursiveTask</span>&lt;<span class="hljs-title">Integer</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">int</span> begin;<br>    <span class="hljs-keyword">int</span> end;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyTask2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> begin, <span class="hljs-keyword">int</span> end)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.begin = begin;<br>        <span class="hljs-keyword">this</span>.end = end;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&quot;</span> + begin + <span class="hljs-string">&quot;,&quot;</span> + end + <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Integer <span class="hljs-title">compute</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 5, 5</span><br>        <span class="hljs-keyword">if</span> (begin == end) &#123;<br>            log.debug(<span class="hljs-string">&quot;join() &#123;&#125;&quot;</span>, begin);<br>            <span class="hljs-keyword">return</span> begin;<br>        &#125;<br>        <span class="hljs-comment">// 4, 5</span><br>        <span class="hljs-keyword">if</span> (end - begin == <span class="hljs-number">1</span>) &#123;<br>            log.debug(<span class="hljs-string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, begin, end, end + begin);<br>            <span class="hljs-keyword">return</span> end + begin;<br>        &#125;<br><br>        <span class="hljs-comment">// 1 5</span><br>        <span class="hljs-keyword">int</span> mid = (end + begin) / <span class="hljs-number">2</span>; <span class="hljs-comment">// 3</span><br>        MyTask2 t1 = <span class="hljs-keyword">new</span> MyTask2(begin, mid); <span class="hljs-comment">// 1,3</span><br>        t1.fork();<br>        MyTask2 t2 = <span class="hljs-keyword">new</span> MyTask2(mid + <span class="hljs-number">1</span>, end); <span class="hljs-comment">// 4,5</span><br>        t2.fork();<br>        log.debug(<span class="hljs-string">&quot;fork() &#123;&#125; + &#123;&#125; = ?&quot;</span>, t1, t2);<br>        <span class="hljs-keyword">int</span> result = t1.join() + t2.join();<br>        log.debug(<span class="hljs-string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, t1, t2, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">1</span>] c.MyTask2 - fork() &#123;<span class="hljs-number">1</span>,<span class="hljs-number">3</span>&#125; + &#123;<span class="hljs-number">4</span>,<span class="hljs-number">5</span>&#125; = ?<br><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">5</span>] c.MyTask2 - join() <span class="hljs-number">3</span><br><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">3</span>] c.MyTask2 - join() <span class="hljs-number">4</span> + <span class="hljs-number">5</span> = <span class="hljs-number">9</span><br><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">4</span>] c.MyTask2 - join() <span class="hljs-number">1</span> + <span class="hljs-number">2</span> = <span class="hljs-number">3</span><br><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">2</span>] c.MyTask2 - fork() &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>&#125; + &#123;<span class="hljs-number">3</span>,<span class="hljs-number">3</span>&#125; = ?<br><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">2</span>] c.MyTask2 - join() &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>&#125; + &#123;<span class="hljs-number">3</span>,<span class="hljs-number">3</span>&#125; = <span class="hljs-number">6</span><br><span class="hljs-number">18</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> [ForkJoinPool-<span class="hljs-number">1</span>-worker-<span class="hljs-number">1</span>] c.MyTask2 - join() &#123;<span class="hljs-number">1</span>,<span class="hljs-number">3</span>&#125; + &#123;<span class="hljs-number">4</span>,<span class="hljs-number">5</span>&#125; = <span class="hljs-number">15</span><br><span class="hljs-number">15</span><br></code></pre></td></tr></table></figure>

<p>用图来表示</p>
<p><img src="http://image.cryptomartin.top/img/image-20220123183829207.png" srcset="/img/loading.gif" lazyload alt="image-20220123183829207"></p>
<h2 id="8-6-J-U-C"><a href="#8-6-J-U-C" class="headerlink" title="8.6 J.U.C"></a>8.6 J.U.C</h2><h3 id="8-6-1-AQS原理"><a href="#8-6-1-AQS原理" class="headerlink" title="8.6.1 AQS原理"></a>8.6.1 AQS原理</h3><h4 id="8-6-1-1-概述"><a href="#8-6-1-1-概述" class="headerlink" title="8.6.1.1 概述"></a>8.6.1.1 概述</h4><p>全称是 AbstractQueuedSynchronizer，是阻塞式锁和相关的同步器工具的框架。子类重写方法</p>
<p>特点：</p>
<ul>
<li>用 state 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取锁和释放锁<ul>
<li>getState - 获取 state 状态</li>
<li>setState - 设置 state 状态</li>
</ul>
</li>
<li>compareAndSetState - cas 机制设置 state 状态</li>
<li>独占模式是只有一个线程能够访问资源，而共享模式可以允许多个线程访问资源</li>
<li>提供了基于 FIFO 的等待队列，类似于 Monitor 的 EntryList</li>
<li>条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet</li>
</ul>
<p>子类主要实现这样一些方法（默认抛出 UnsupportedOperationException）</p>
<ul>
<li>tryAcquire</li>
<li>tryRelease</li>
<li>tryAcquireShared</li>
<li>tryReleaseShared</li>
<li>isHeldExclusively</li>
</ul>
<p>如何获取锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 如果获取锁失败</span><br><span class="hljs-keyword">if</span> (!tryAcquire(arg)) &#123;<br> <span class="hljs-comment">// 入队, 可以选择阻塞当前线程 park unpark</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>如何释放锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 如果释放锁成功</span><br><span class="hljs-keyword">if</span> (tryRelease(arg)) &#123;<br> <span class="hljs-comment">// 让阻塞线程恢复运行</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="8-6-1-2-实现不可重入锁"><a href="#8-6-1-2-实现不可重入锁" class="headerlink" title="8.6.1.2 实现不可重入锁"></a>8.6.1.2 实现不可重入锁</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestAQS&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAQS</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MyLock lock = <span class="hljs-keyword">new</span> MyLock();<br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;locking...&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;unlocking...&quot;</span>);<br>                lock.unlock();<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;locking...&quot;</span>);<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;unlocking...&quot;</span>);<br>                lock.unlock();<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//自定义锁（不可重入锁：线程加锁后不能再次加锁）</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span> </span>&#123;<br><br>    <span class="hljs-comment">//实现独占锁</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span> </span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>&#123;<br>            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>                setExclusiveOwnerThread(Thread.currentThread());<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryRelease</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>&#123;<br>            setExclusiveOwnerThread(<span class="hljs-keyword">null</span>);<br>            setState(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><span class="hljs-comment">//是否持有独占锁</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHeldExclusively</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConditionObject();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> MySync mySync = <span class="hljs-keyword">new</span> MySync();<br><br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//加锁，不成功会进入等待队列</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;<br>        mySync.acquire(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//加锁，可打断</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        mySync.acquireInterruptibly(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//尝试加锁，仅尝试一次</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mySync.tryAcquire(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//尝试加锁，带超时</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-keyword">return</span> mySync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(time));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//解锁</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br>        mySync.release(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//创建条件变量</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mySync.newCondition();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05</span> [t1] c.TestAQS - locking...<br><span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">06</span> [t1] c.TestAQS - unlocking...<br><span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">06</span> [t2] c.TestAQS - locking...<br><span class="hljs-number">16</span>:<span class="hljs-number">06</span>:<span class="hljs-number">06</span> [t2] c.TestAQS - unlocking...<br></code></pre></td></tr></table></figure>



<h3 id="8-6-2-ReentrantLock-原理"><a href="#8-6-2-ReentrantLock-原理" class="headerlink" title="8.6.2 ReentrantLock 原理"></a>8.6.2 ReentrantLock 原理</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd?p=238">ReentrantLock 原理 P238-P246</a></p>
<p><img src="http://image.cryptomartin.top/img/image-20220124222445832.png" srcset="/img/loading.gif" lazyload alt="image-20220124222445832"></p>
<h4 id="8-6-2-1-非公平锁实现原理"><a href="#8-6-2-1-非公平锁实现原理" class="headerlink" title="8.6.2.1 非公平锁实现原理"></a>8.6.2.1 非公平锁实现原理</h4><p><strong>加锁解锁流程</strong></p>
<p>先从构造器开始看，默认为非公平锁实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReentrantLock</span><span class="hljs-params">()</span> </span>&#123;<br> sync = <span class="hljs-keyword">new</span> NonfairSync();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>NonfairSync 继承自 AQS</p>
<p>没有竞争时</p>
<p><img src="http://image.cryptomartin.top/img/image-20220124222701599.png" srcset="/img/loading.gif" lazyload alt="image-20220124222701599"></p>
<p>第一个竞争出现时</p>
<p><img src="http://image.cryptomartin.top/img/image-20220124222733411.png" srcset="/img/loading.gif" lazyload alt="image-20220124222733411"></p>
<p>Thread-1 执行了</p>
<ol>
<li>CAS 尝试将 state 由 0 改为 1，结果失败</li>
<li>进入 tryAcquire 逻辑，这时 state 已经是1，结果仍然失败</li>
<li>接下来进入 addWaiter 逻辑，构造 Node 队列</li>
</ol>
<ul>
<li>图中黄色三角表示该 Node 的 waitStatus 状态，其中 0 为默认正常状态</li>
<li>Node 的创建是懒惰的</li>
<li>其中第一个 Node 称为 Dummy（哑元）或哨兵，用来占位，并不关联线程</li>
</ul>
<p>当前线程进入 acquireQueued 逻辑</p>
<ol>
<li>acquireQueued 会在一个死循环中不断尝试获得锁，失败后进入 park 阻塞</li>
<li>如果自己是紧邻着 head（排第二位），那么再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败</li>
<li>进入 shouldParkAfterFailedAcquire 逻辑，将前驱 node，即 head 的 waitStatus 改为 -1，这次返回 false</li>
</ol>
<p><img src="http://image.cryptomartin.top/img/image-20220124223513426.png" srcset="/img/loading.gif" lazyload alt="image-20220124223513426"></p>
<ol start="4">
<li>shouldParkAfterFailedAcquire 执行完毕回到 acquireQueued ，再次 tryAcquire 尝试获取锁，当然这时state 仍为 1，失败</li>
<li>当再次进入 shouldParkAfterFailedAcquire 时，这时因为其前驱 node 的 waitStatus 已经是 -1，这次返回true</li>
<li>进入 parkAndCheckInterrupt， Thread-1 park（灰色表示）</li>
</ol>
<p><img src="http://image.cryptomartin.top/img/image-20220124223648455.png" srcset="/img/loading.gif" lazyload alt="image-20220124223648455"></p>
<p>再次有多个线程经历上述过程竞争失败，变成这个样子</p>
<p><img src="http://image.cryptomartin.top/img/image-20220124223708589.png" srcset="/img/loading.gif" lazyload alt="image-20220124223708589"></p>
<p>Thread-0 释放锁，进入 tryRelease 流程，如果成功</p>
<ul>
<li>设置 exclusiveOwnerThread 为 null</li>
<li>state = 0</li>
</ul>
<p><img src="http://image.cryptomartin.top/img/image-20220124223744024.png" srcset="/img/loading.gif" lazyload alt="image-20220124223744024"></p>
<p>当前队列不为 null，并且 head 的 waitStatus = -1，进入 unparkSuccessor 流程<br>找到队列中离 head 最近的一个 Node（没取消的），unpark 恢复其运行，本例中即为 Thread-1<br>回到 Thread-1 的 acquireQueued 流程</p>
<p><img src="http://image.cryptomartin.top/img/image-20220124223820877.png" srcset="/img/loading.gif" lazyload alt="image-20220124223820877"></p>
<p>如果加锁成功（没有竞争），会设置</p>
<ul>
<li>exclusiveOwnerThread 为 Thread-1，state = 1</li>
<li>head 指向刚刚 Thread-1 所在的 Node，该 Node 清空 Thread</li>
<li>原本的 head 因为从链表断开，而可被垃圾回收</li>
</ul>
<p>如果这时候有其它线程来竞争（非公平的体现），例如这时有 Thread-4 来了</p>
<p><img src="http://image.cryptomartin.top/img/image-20220124223924346.png" srcset="/img/loading.gif" lazyload alt="image-20220124223924346"></p>
<p>如果不巧又被 Thread-4 占了先</p>
<ul>
<li>Thread-4 被设置为 exclusiveOwnerThread，state = 1</li>
<li>Thread-1 再次进入 acquireQueued 流程，获取锁失败，重新进入 park 阻塞</li>
</ul>
<h4 id="8-6-2-2-可重入原理"><a href="#8-6-2-2-可重入原理" class="headerlink" title="8.6.2.2 可重入原理"></a>8.6.2.2 可重入原理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Sync</span> </span>&#123;<br>	<span class="hljs-comment">// ...</span><br>	<span class="hljs-comment">// Sync 继承过来的方法, 方便阅读, 放在此处</span><br>	<span class="hljs-function"><span class="hljs-keyword">final</span> Boolean <span class="hljs-title">nonfairTryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> acquires)</span> </span>&#123;<br>		<span class="hljs-keyword">final</span> Thread current = Thread.currentThread();<br>		<span class="hljs-keyword">int</span> c = getState();<br>		<span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, acquires)) &#123;<br>				setExclusiveOwnerThread(current);<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入 else if (current == getExclusiveOwnerThread()) &#123;</span><br>			<span class="hljs-comment">// state++</span><br>			<span class="hljs-keyword">int</span> nextc = c + acquires;<br>			<span class="hljs-keyword">if</span> (nextc &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>			setState(nextc);<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>	&#125;<br><br>	<span class="hljs-comment">// Sync 继承过来的方法, 方便阅读, 放在此处</span><br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Boolean <span class="hljs-title">tryRelease</span><span class="hljs-params">(<span class="hljs-keyword">int</span> releases)</span> </span>&#123;<br>		<span class="hljs-comment">// state-- </span><br>		<span class="hljs-keyword">int</span> c = getState() - releases;<br>		<span class="hljs-keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())<br>		 <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalMonitorStateException();<br>		Boolean free = <span class="hljs-keyword">false</span>;<br>		<span class="hljs-comment">// 支持锁重入, 只有 state 减为 0, 才释放成功</span><br>		<span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) &#123;<br>			free = <span class="hljs-keyword">true</span>;<br>			setExclusiveOwnerThread(<span class="hljs-keyword">null</span>);<br>		&#125;<br>		setState(c);<br>		<span class="hljs-keyword">return</span> free;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>总结：加锁时，重入让state自增；解锁时，让state自减，减为0才解开。</p>
</blockquote>
<h4 id="8-6-2-3-可打断原理"><a href="#8-6-2-3-可打断原理" class="headerlink" title="8.6.2.3 可打断原理"></a>8.6.2.3 可打断原理</h4><p><strong>不可打断模式</strong></p>
<p>在此模式下，即使它被打断，仍会驻留在 AQS 队列中，一直要等到获得锁后方能得知自己被打断了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Sync 继承自 AQS</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Sync</span> </span>&#123;<br>	<span class="hljs-comment">// ...</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Boolean <span class="hljs-title">parkAndCheckInterrupt</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-comment">// 如果打断标记已经是 true, 则 park 会失效</span><br>		LockSupport.park(<span class="hljs-keyword">this</span>);<br>		<span class="hljs-comment">// interrupted 会清除打断标记</span><br>		<span class="hljs-keyword">return</span> Thread.interrupted();<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">final</span> Boolean <span class="hljs-title">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-keyword">int</span> arg)</span> </span>&#123;<br>		Boolean failed = <span class="hljs-keyword">true</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			Boolean interrupted = <span class="hljs-keyword">false</span>;<br>			<span class="hljs-keyword">for</span> (;;) &#123;<br>				<span class="hljs-keyword">final</span> Node p = node.predecessor();<br>				<span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;<br>					setHead(node);<br>					p.next = <span class="hljs-keyword">null</span>;<br>					failed = <span class="hljs-keyword">false</span>;<br>					<span class="hljs-comment">// 还是需要获得锁后, 才能返回打断状态</span><br>					<span class="hljs-keyword">return</span> interrupted;<br>				&#125;<br>				<span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;parkAndCheckInterrupt()) &#123;<br>					<span class="hljs-comment">// 如果是因为 interrupt 被唤醒, 返回打断状态为 true</span><br>					interrupted = <span class="hljs-keyword">true</span>;<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			<span class="hljs-keyword">if</span> (failed)<br>			 cancelAcquire(node);<br>		&#125;<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>&#123;<br>		<span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) &#123;<br>			<span class="hljs-comment">// 如果打断状态为 true</span><br>			selfInterrupt();<br>		&#125;<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">selfInterrupt</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-comment">// 重新产生一次中断;获取到锁以后，打断才生效</span><br>		Thread.currentThread().interrupt();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>可打断模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Sync</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquireInterruptibly</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>		<span class="hljs-keyword">if</span> (Thread.interrupted())<br>		 <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<br>		<span class="hljs-comment">// 如果没有获得到锁, 进入 ㈠</span><br>		<span class="hljs-keyword">if</span> (!tryAcquire(arg))<br>		 doAcquireInterruptibly(arg);<br>	&#125;<br>	<span class="hljs-comment">// ㈠ 可打断的获取锁流程</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doAcquireInterruptibly</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>		<span class="hljs-keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);<br>		Boolean failed = <span class="hljs-keyword">true</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-keyword">for</span> (;;) &#123;<br>				<span class="hljs-keyword">final</span> Node p = node.predecessor();<br>				<span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;<br>					setHead(node);<br>					p.next = <span class="hljs-keyword">null</span>;<br>					<span class="hljs-comment">// help GC</span><br>					failed = <span class="hljs-keyword">false</span>;<br>					<span class="hljs-keyword">return</span>;<br>				&#125;<br>				<span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;<br>				 parkAndCheckInterrupt()) &#123;<br>					<span class="hljs-comment">// 在 park 过程中如果被 interrupt 会进入此</span><br>					<span class="hljs-comment">// 这时候抛出异常, 而不会再次进入 for (;;)</span><br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			<span class="hljs-keyword">if</span> (failed)<br>			 cancelAcquire(node);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>总结：</p>
<p>可打断模式：在队列中不可被打断，当线程获得锁以后，就被打断执行；</p>
<p>可打断模式：在队列中被打断，直接抛异常。</p>
</blockquote>
<h4 id="8-6-2-4-公平锁原理"><a href="#8-6-2-4-公平锁原理" class="headerlink" title="8.6.2.4 公平锁原理"></a>8.6.2.4 公平锁原理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Sync</span> </span>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">3000897897090466540L</span>;<br>	<span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;<br>		acquire(<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-comment">// AQS 继承过来的方法, 方便阅读, 放在此处</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>&#123;<br>		<span class="hljs-keyword">if</span> (<br>		 !tryAcquire(arg) &amp;&amp;<br>		 acquireQueued(addWaiter(Node.EXCLUSIVE), arg)<br>		 ) &#123;<br>			selfInterrupt();<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 与非公平锁主要区别在于 tryAcquire 方法的实现</span><br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Boolean <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> acquires)</span> </span>&#123;<br>		<span class="hljs-keyword">final</span> Thread current = Thread.currentThread();<br>		<span class="hljs-keyword">int</span> c = getState();<br>		<span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-comment">// 先检查 AQS 队列中是否有前驱节点, 没有才去竞争</span><br>			<span class="hljs-keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;<br>			 compareAndSetState(<span class="hljs-number">0</span>, acquires)) &#123;<br>				setExclusiveOwnerThread(current);<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current == getExclusiveOwnerThread()) &#123;<br>			<span class="hljs-keyword">int</span> nextc = c + acquires;<br>			<span class="hljs-keyword">if</span> (nextc &lt; <span class="hljs-number">0</span>)<br>			 <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>			setState(nextc);<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>	&#125;<br>	<span class="hljs-comment">// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Boolean <span class="hljs-title">hasQueuedPredecessors</span><span class="hljs-params">()</span> </span>&#123;<br>		Node t = tail;<br>		Node h = head;<br>		Node s;<br>		<span class="hljs-comment">// h != t 时表示队列中有 Node</span><br>		<span class="hljs-keyword">return</span> h != t &amp;&amp;<br>		 (<br>		 <span class="hljs-comment">// (s = h.next) == null 表示队列中还有没有老二</span><br>		(s = h.next) == <span class="hljs-keyword">null</span> ||<br>		   <span class="hljs-comment">// 或者队列中老二线程不是此线程</span><br>		s.thread != Thread.currentThread()<br>		 );<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="8-6-2-5-条件变量实现原理"><a href="#8-6-2-5-条件变量实现原理" class="headerlink" title="8.6.2.5 条件变量实现原理"></a>8.6.2.5 条件变量实现原理</h4><p>每个条件变量其实就对应着一个等待队列，其实现类是 ConditionObjec</p>
<p><strong>await流程</strong></p>
<p>开始 Thread-0 持有锁，调用 await，进入 ConditionObject 的 addConditionWaiter 流程</p>
<p>创建新的 Node 状态为 -2（Node.CONDITION），关联 Thread-0，加入等待队列尾部</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125111922944.png" srcset="/img/loading.gif" lazyload alt="image-20220125111922944"></p>
<p>接下来进入 AQS 的 fullyRelease 流程，释放同步器上的锁</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125112201735.png" srcset="/img/loading.gif" lazyload alt="image-20220125112201735"></p>
<p>unpark AQS 队列中的下一个节点，竞争锁，假设没有其他竞争线程，那么 Thread-1 竞争成功</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125112242019.png" srcset="/img/loading.gif" lazyload alt="image-20220125112242019"></p>
<p>park 阻塞 Thread-0</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125112309929.png" srcset="/img/loading.gif" lazyload alt="image-20220125112309929"></p>
<p><strong>signal流程</strong></p>
<p>假设 Thread-1 要来唤醒 Thread-0</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125112345029.png" srcset="/img/loading.gif" lazyload alt="image-20220125112345029"></p>
<p>进入 ConditionObject 的 doSignal 流程，取得等待队列中第一个 Node，即 Thread-0 所在 Node</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125112411414.png" srcset="/img/loading.gif" lazyload alt="image-20220125112411414"></p>
<p>执行 transferForSignal 流程，将该 Node 加入 AQS 队列尾部，将 Thread-0 的 waitStatus 改为 0，Thread-3 的waitStatus 改为-1 </p>
<p><img src="http://image.cryptomartin.top/img/image-20220125112444665.png" srcset="/img/loading.gif" lazyload alt="image-20220125112444665"></p>
<p>Thread-1 释放锁，进入 unlock 流程，略</p>
<h3 id="8-6-3-读写锁原理"><a href="#8-6-3-读写锁原理" class="headerlink" title="8.6.3 读写锁原理"></a>8.6.3 读写锁原理</h3><h4 id="8-6-3-1-ReentrantReadWriteLock"><a href="#8-6-3-1-ReentrantReadWriteLock" class="headerlink" title="8.6.3.1  ReentrantReadWriteLock"></a>8.6.3.1  ReentrantReadWriteLock</h4><p>当读操作远远高于写操作时，这时候使用<code>读写锁</code>让<code>读-读</code>可以并发提高性能。类似于数据库中的<code>select...from...lock in share mode</code></p>
<p>提供一个<code>数据容器类</code>内部分别使用 读锁保护数据的 <code>read()</code>方法，写锁保护数据的<code>write()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataContainer</span> </span>&#123;<br>	<span class="hljs-keyword">private</span> Object data;<br>	<span class="hljs-keyword">private</span> ReentrantReadWriteLock rw = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>	<span class="hljs-keyword">private</span> ReentrantReadWriteLock.ReadLock r = rw.readLock();<br>	<span class="hljs-keyword">private</span> ReentrantReadWriteLock.WriteLock w = rw.writeLock();<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>		log.debug(<span class="hljs-string">&quot;获取读锁...&quot;</span>);<br>		r.lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			log.debug(<span class="hljs-string">&quot;读取&quot;</span>);<br>			sleep(<span class="hljs-number">1</span>);<br>			<span class="hljs-keyword">return</span> data;<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			log.debug(<span class="hljs-string">&quot;释放读锁...&quot;</span>);<br>			r.unlock();<br>		&#125;<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">()</span> </span>&#123;<br>		log.debug(<span class="hljs-string">&quot;获取写锁...&quot;</span>);<br>		w.lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			log.debug(<span class="hljs-string">&quot;写入&quot;</span>);<br>			sleep(<span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			log.debug(<span class="hljs-string">&quot;释放写锁...&quot;</span>);<br>			w.unlock();<br>		&#125;<br>	&#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>读读可以并发，读写/写写会阻塞</p>
</blockquote>
<p><strong>注意事项</strong></p>
<ul>
<li><p>读锁不支持条件变量</p>
</li>
<li><p>重入时升级不支持：即持有读锁的情况下去获取写锁，会导致获取写锁永久等待</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">r.lock();<br><span class="hljs-keyword">try</span> &#123;<br>	<span class="hljs-comment">// ...</span><br>	w.lock();<br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-comment">// ...</span><br>	&#125;<span class="hljs-keyword">finally</span>&#123;<br>		w.unlock();<br>	&#125;<br>&#125;<span class="hljs-keyword">finally</span>&#123;<br>	r.unlock();<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>重入时降级支持：即持有写锁的情况下去获取读锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedData</span> </span>&#123;<br>	Object data;<br>	<span class="hljs-comment">// 是否有效，如果失效，需要重新计算 data</span><br>	<span class="hljs-keyword">volatile</span> Boolean cacheValid;<br>	<span class="hljs-keyword">final</span> ReentrantReadWriteLock rwl = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processCachedData</span><span class="hljs-params">()</span> </span>&#123;<br>		rwl.readLock().lock();<br>		<span class="hljs-keyword">if</span> (!cacheValid) &#123;<br>			<span class="hljs-comment">// 获取写锁前必须释放读锁</span><br>			rwl.readLock().unlock();<br>			rwl.writeLock().lock();<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">// 判断是否有其它线程已经获取了写锁、更新了缓存, 避免重复更新</span><br>				<span class="hljs-keyword">if</span> (!cacheValid) &#123;<br>					data = ...<br>					 cacheValid = <span class="hljs-keyword">true</span>;<br>				&#125;<br>				<span class="hljs-comment">// 降级为读锁, 释放写锁, 这样能够让其它线程读取缓存</span><br>				rwl.readLock().lock();<br>			&#125;<span class="hljs-keyword">finally</span> &#123;<br>				rwl.writeLock().unlock();<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 自己用完数据, 释放读锁 </span><br>		<span class="hljs-keyword">try</span> &#123;<br>			use(data);<br>		&#125;<span class="hljs-keyword">finally</span> &#123;<br>			rwl.readLock().unlock();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-6-3-2-【应用】缓存实现"><a href="#8-6-3-2-【应用】缓存实现" class="headerlink" title="8.6.3.2 【应用】缓存实现"></a>8.6.3.2 【应用】缓存实现</h4><p><strong>1.缓存更新策略</strong></p>
<p>更新时，是先清缓存还是先更新数据库</p>
<p>先清缓存</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125161540423.png" srcset="/img/loading.gif" lazyload alt="image-20220125161540423"></p>
<p>先更新数据库</p>
<p><img src="http://image.cryptomartin.top/img/image-20220125161635164.png" srcset="/img/loading.gif" lazyload alt="image-20220125161635164"></p>
<p><strong>2. 读写锁实现一致性缓存</strong></p>
<p>使用读写锁实现一个简单的按需加载缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericCachedDao</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>	<span class="hljs-comment">// HashMap 作为缓存非线程安全, 需要保护</span><br>	HashMap&lt;SqlPair, T&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>	ReentrantReadWriteLock lock = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>	GenericDao genericDao = <span class="hljs-keyword">new</span> GenericDao();<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(String sql, Object... params)</span> </span>&#123;<br>		SqlPair key = <span class="hljs-keyword">new</span> SqlPair(sql, params);<br>		<span class="hljs-comment">// 加写锁, 防止其它线程对缓存读取和更改</span><br>		lock.writeLock().lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-keyword">int</span> rows = genericDao.update(sql, params);<br>			map.clear();<br>			<span class="hljs-keyword">return</span> rows;<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			lock.writeLock().unlock();<br>		&#125;<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">queryOne</span><span class="hljs-params">(Class&lt;T&gt; beanClass, String sql, Object... params)</span> </span>&#123;<br>		SqlPair key = <span class="hljs-keyword">new</span> SqlPair(sql, params);<br>		<span class="hljs-comment">// 加读锁, 防止其它线程对缓存更改</span><br>		lock.readLock().lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			T value = map.get(key);<br>			<span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">return</span> value;<br>			&#125;<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			lock.readLock().unlock();<br>		&#125;<br>		<span class="hljs-comment">// 加写锁, 防止其它线程对缓存读取和更改</span><br>		lock.writeLock().lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// get 方法上面部分是可能多个线程进来的, 可能已经向缓存填充了数据</span><br>			<span class="hljs-comment">// 为防止重复查询数据库, 再次验证</span><br>			T value = map.get(key);<br>			<span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-comment">// 如果没有, 查询数据库</span><br>				value = genericDao.queryOne(beanClass, sql, params);<br>				map.put(key, value);<br>			&#125;<br>			<span class="hljs-keyword">return</span> value;<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			lock.writeLock().unlock();<br>		&#125;<br>	&#125;<br>    <br>	<span class="hljs-comment">// 作为 key 保证其是不可变的</span><br>	<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlPair</span> </span>&#123;<br>		<span class="hljs-keyword">private</span> String sql;<br>		<span class="hljs-keyword">private</span> Object[] params;<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlPair</span><span class="hljs-params">(String sql, Object[] params)</span> </span>&#123;<br>			<span class="hljs-keyword">this</span>.sql = sql;<br>			<span class="hljs-keyword">this</span>.params = params;<br>		&#125;<br>		<span class="hljs-meta">@Override</span><br>		 <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">equals</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == o) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">null</span> || getClass() != o.getClass()) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>			&#125;<br>			SqlPair sqlPair = (SqlPair) o;<br>			<span class="hljs-keyword">return</span> sql.equals(sqlPair.sql) &amp;&amp;<br>			 Arrays.equals(params, sqlPair.params);<br>		&#125;<br>		<span class="hljs-meta">@Override</span><br>		 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>			<span class="hljs-keyword">int</span> result = Objects.hash(sql);<br>			result = <span class="hljs-number">31</span> * result + Arrays.hashCode(params);<br>			<span class="hljs-keyword">return</span> result;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<p>以上实现体现的是读写锁的应用，保证缓存和数据库的一致性，但有下面的问题没有考虑</p>
<ul>
<li>适合读多写少，如果写操作比较频繁，以上实现性能低</li>
<li>没有考虑缓存容量</li>
<li>没有考虑缓存过期</li>
<li>只适合单机</li>
<li>并发性还是低，目前只会用一把锁</li>
<li>更新方法太过简单粗暴，清空了所有 key（考虑按类型分区或重新设计 key）</li>
</ul>
<p>乐观锁实现：用 CAS 去更新</p>
</blockquote>
<h4 id="8-6-3-3-读写锁原理"><a href="#8-6-3-3-读写锁原理" class="headerlink" title="8.6.3.3 读写锁原理"></a>8.6.3.3 读写锁原理</h4><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd?p=253">reentrantreadwritelock-原理 P253-P258</a></p>
<h4 id="8-6-3-4-StampedLock"><a href="#8-6-3-4-StampedLock" class="headerlink" title="8.6.3.4 StampedLock"></a>8.6.3.4 <strong>StampedLock</strong></h4><p>该类自 JDK 8 加入，是为了进一步优化读性能，它的特点是在使用读锁、写锁时都必须配合【戳】使用</p>
<p>加解读锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">long</span> stamp = lock.readLock();<br>lock.unlockRead(stamp);<br></code></pre></td></tr></table></figure>

<p>加解写锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">long</span> stamp = lock.writeLock();<br>lock.unlockWrite(stamp);<br></code></pre></td></tr></table></figure>



<p>乐观读，StampedLock 支持<code>tryOptimisticRead()</code>方法（乐观读），读取完毕后需要做一次<code>戳校验</code>如果校验通过，表示这期间确实没有写操作，数据可以安全使用，如果校验没通过，需要重新获取读锁，保证数据安全。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">long</span> stamp = lock.tryOptimisticRead();<br><span class="hljs-comment">// 验戳</span><br><span class="hljs-keyword">if</span>(!lock.validate(stamp))&#123;<br> <span class="hljs-comment">// 锁升级</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>提供一个<code>数据容器类</code>内部分别使用读锁保护数据的<code>read()</code>方法，写锁保护数据的<code>write()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataContainerStamped</span> </span>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> data;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StampedLock lock = <span class="hljs-keyword">new</span> StampedLock();<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataContainerStamped</span><span class="hljs-params">(<span class="hljs-keyword">int</span> data)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.data = data;<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-keyword">int</span> readTime)</span> </span>&#123;<br>		<span class="hljs-keyword">long</span> stamp = lock.tryOptimisticRead();<br>		log.debug(<span class="hljs-string">&quot;optimistic read locking...&#123;&#125;&quot;</span>, stamp);<br>		sleep(readTime);<br>		<span class="hljs-keyword">if</span> (lock.validate(stamp)) &#123;<br>			log.debug(<span class="hljs-string">&quot;read finish...&#123;&#125;, data:&#123;&#125;&quot;</span>, stamp, data);<br>			<span class="hljs-keyword">return</span> data;<br>		&#125;<br>		<span class="hljs-comment">// 锁升级 - 读锁</span><br>		log.debug(<span class="hljs-string">&quot;updating to read lock... &#123;&#125;&quot;</span>, stamp);<br>		<span class="hljs-keyword">try</span> &#123;<br>			stamp = lock.readLock();<br>			log.debug(<span class="hljs-string">&quot;read lock &#123;&#125;&quot;</span>, stamp);<br>			sleep(readTime);<br>			log.debug(<span class="hljs-string">&quot;read finish...&#123;&#125;, data:&#123;&#125;&quot;</span>, stamp, data);<br>			<span class="hljs-keyword">return</span> data;<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			log.debug(<span class="hljs-string">&quot;read unlock &#123;&#125;&quot;</span>, stamp);<br>			lock.unlockRead(stamp);<br>		&#125;<br>	&#125;<br>    <br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newData)</span> </span>&#123;<br>		<span class="hljs-keyword">long</span> stamp = lock.writeLock();<br>		log.debug(<span class="hljs-string">&quot;write lock &#123;&#125;&quot;</span>, stamp);<br>		<span class="hljs-keyword">try</span> &#123;<br>			sleep(<span class="hljs-number">2</span>);<br>			<span class="hljs-keyword">this</span>.data = newData;<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			log.debug(<span class="hljs-string">&quot;write unlock &#123;&#125;&quot;</span>, stamp);<br>			lock.unlockWrite(stamp);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试<code>读-读</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>	DataContainerStamped dataContainer = <span class="hljs-keyword">new</span> DataContainerStamped(<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		dataContainer.read(<span class="hljs-number">1</span>);<br>	&#125;<br>	, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>	sleep(<span class="hljs-number">0.5</span>);<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		dataContainer.read(<span class="hljs-number">0</span>);<br>	&#125;<br>	, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">15</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.217</span> c.DataContainerStamped [t1] - optimistic read locking..<span class="hljs-number">.256</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.717</span> c.DataContainerStamped [t2] - optimistic read locking..<span class="hljs-number">.256</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.717</span> c.DataContainerStamped [t2] - read finish..<span class="hljs-number">.256</span>, data:<span class="hljs-number">1</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">58</span>:<span class="hljs-number">51.220</span> c.DataContainerStamped [t1] - read finish..<span class="hljs-number">.256</span>, data:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>测试<code>读-写</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>	DataContainerStamped dataContainer = <span class="hljs-keyword">new</span> DataContainerStamped(<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		dataContainer.read(<span class="hljs-number">1</span>);<br>	&#125;<br>	, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>	sleep(<span class="hljs-number">0.5</span>);<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		dataContainer.write(<span class="hljs-number">100</span>);<br>	&#125;<br>	, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">00.219</span> c.DataContainerStamped [t1] - optimistic read locking..<span class="hljs-number">.256</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">00.717</span> c.DataContainerStamped [t2] - write lock <span class="hljs-number">384</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">01.225</span> c.DataContainerStamped [t1] - updating to read lock... <span class="hljs-number">256</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">02.719</span> c.DataContainerStamped [t2] - write unlock <span class="hljs-number">384</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">02.719</span> c.DataContainerStamped [t1] - read lock <span class="hljs-number">513</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">03.719</span> c.DataContainerStamped [t1] - read finish..<span class="hljs-number">.513</span>, data:<span class="hljs-number">1000</span> <br><span class="hljs-number">15</span>:<span class="hljs-number">57</span>:<span class="hljs-number">03.719</span> c.DataContainerStamped [t1] - read unlock <span class="hljs-number">513</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<ul>
<li>StampedLock 不支持条件变量</li>
<li>StampedLock 不支持可重入</li>
</ul>
</blockquote>
<h3 id="8-6-4-Semaphore"><a href="#8-6-4-Semaphore" class="headerlink" title="8.6.4 Semaphore"></a>8.6.4 Semaphore</h3><h4 id="8-6-4-1-基本使用"><a href="#8-6-4-1-基本使用" class="headerlink" title="8.6.4.1 基本使用"></a>8.6.4.1 基本使用</h4><p>[ˈsɛməˌfɔr] 信号量，用来限制能同时访问共享资源的线程上限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>	<span class="hljs-comment">// 1. 创建 semaphore 对象</span><br>	Semaphore semaphore = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>);<br>	<span class="hljs-comment">// 2. 10个线程同时运行</span><br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-comment">// 3. 获取许可</span><br>			<span class="hljs-keyword">try</span> &#123;<br>				semaphore.acquire();<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>			<span class="hljs-keyword">try</span> &#123;<br>				log.debug(<span class="hljs-string">&quot;running...&quot;</span>);<br>				sleep(<span class="hljs-number">1</span>);<br>				log.debug(<span class="hljs-string">&quot;end...&quot;</span>);<br>			&#125;<br>			<span class="hljs-keyword">finally</span> &#123;<br>				<span class="hljs-comment">// 4. 释放许可</span><br>				semaphore.release();<br>			&#125;<br>		&#125;<br>		).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">15.485</span> c.TestSemaphore [Thread-<span class="hljs-number">2</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">15.485</span> c.TestSemaphore [Thread-<span class="hljs-number">1</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">15.485</span> c.TestSemaphore [Thread-<span class="hljs-number">0</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.490</span> c.TestSemaphore [Thread-<span class="hljs-number">2</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.490</span> c.TestSemaphore [Thread-<span class="hljs-number">0</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.490</span> c.TestSemaphore [Thread-<span class="hljs-number">1</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.490</span> c.TestSemaphore [Thread-<span class="hljs-number">3</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.490</span> c.TestSemaphore [Thread-<span class="hljs-number">5</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.490</span> c.TestSemaphore [Thread-<span class="hljs-number">4</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">17.490</span> c.TestSemaphore [Thread-<span class="hljs-number">5</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">17.490</span> c.TestSemaphore [Thread-<span class="hljs-number">4</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">17.490</span> c.TestSemaphore [Thread-<span class="hljs-number">3</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">17.490</span> c.TestSemaphore [Thread-<span class="hljs-number">6</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">17.490</span> c.TestSemaphore [Thread-<span class="hljs-number">7</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">17.490</span> c.TestSemaphore [Thread-<span class="hljs-number">9</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">18.491</span> c.TestSemaphore [Thread-<span class="hljs-number">6</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">18.491</span> c.TestSemaphore [Thread-<span class="hljs-number">7</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">18.491</span> c.TestSemaphore [Thread-<span class="hljs-number">9</span>] - end... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">18.491</span> c.TestSemaphore [Thread-<span class="hljs-number">8</span>] - running... <br><span class="hljs-number">07</span>:<span class="hljs-number">35</span>:<span class="hljs-number">19.492</span> c.TestSemaphore [Thread-<span class="hljs-number">8</span>] - end...<br></code></pre></td></tr></table></figure>



<h4 id="8-6-4-2-【应用】Semaphore应用"><a href="#8-6-4-2-【应用】Semaphore应用" class="headerlink" title="8.6.4.2 【应用】Semaphore应用"></a>8.6.4.2 【应用】Semaphore应用</h4><p><strong>限制对共享资源的使用</strong></p>
<p>semaphore 实现</p>
<ul>
<li>使用 Semaphore 限流，在访问高峰期时，让请求线程阻塞，高峰期过去再释放许可，当然它只适合限制单机线程数量，并且仅是限制线程数，而不是限制资源数（例如连接数，请对比 Tomcat LimitLatch 的实现）</li>
<li>用 Semaphore 实现简单连接池，对比『享元模式』下的实现（用wait notify），性能和可读性显然更好，注意下面的实现中线程数和数据库连接数是相等的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Pool&quot;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pool</span> </span>&#123;<br>	<span class="hljs-comment">// 1. 连接池大小</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> poolSize;<br>	<span class="hljs-comment">// 2. 连接对象数组</span><br>	<span class="hljs-keyword">private</span> Connection[] connections;<br>	<span class="hljs-comment">// 3. 连接状态数组 0 表示空闲， 1 表示繁忙</span><br>	<span class="hljs-keyword">private</span> AtomicIntegerArray states;<br>	<span class="hljs-keyword">private</span> Semaphore semaphore;<br>	<span class="hljs-comment">// 4. 构造方法初始化</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Pool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> poolSize)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.poolSize = poolSize;<br>		<span class="hljs-comment">// 让许可数与资源数一致</span><br>		<span class="hljs-keyword">this</span>.semaphore = <span class="hljs-keyword">new</span> Semaphore(poolSize);<br>		<span class="hljs-keyword">this</span>.connections = <span class="hljs-keyword">new</span> Connection[poolSize];<br>		<span class="hljs-keyword">this</span>.states = <span class="hljs-keyword">new</span> AtomicIntegerArray(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[poolSize]);<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; poolSize; i++) &#123;<br>			connections[i] = <span class="hljs-keyword">new</span> MockConnection(<span class="hljs-string">&quot;连接&quot;</span> + (i+<span class="hljs-number">1</span>));<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 5. 借连接</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Connection <span class="hljs-title">borrow</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-comment">// t1, t2, t3</span><br>		<span class="hljs-comment">// 获取许可</span><br>		<span class="hljs-keyword">try</span> &#123;<br>			semaphore.acquire();<br>			<span class="hljs-comment">// 没有许可的线程，在此等待</span><br>		&#125;<br>		<span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; poolSize; i++) &#123;<br>			<span class="hljs-comment">// 获取空闲连接</span><br>			<span class="hljs-keyword">if</span>(states.get(i) == <span class="hljs-number">0</span>) &#123;<br>				<span class="hljs-keyword">if</span> (states.compareAndSet(i, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>					log.debug(<span class="hljs-string">&quot;borrow &#123;&#125;&quot;</span>, connections[i]);<br>					<span class="hljs-keyword">return</span> connections[i];<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 不会执行到这里</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>	&#125;<br>	<span class="hljs-comment">// 6. 归还连接</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">free</span><span class="hljs-params">(Connection conn)</span> </span>&#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; poolSize; i++) &#123;<br>			<span class="hljs-keyword">if</span> (connections[i] == conn) &#123;<br>				states.set(i, <span class="hljs-number">0</span>);<br>				log.debug(<span class="hljs-string">&quot;free &#123;&#125;&quot;</span>, conn);<br>				semaphore.release();<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="8-6-4-3-【原理】Semaphore原理"><a href="#8-6-4-3-【原理】Semaphore原理" class="headerlink" title="8.6.4.3 【原理】Semaphore原理"></a>8.6.4.3 【原理】Semaphore原理</h4><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd?p=264">Semaphore原理视频讲解 P264-P265</a></p>
<h3 id="8-6-5-CountdownLatch"><a href="#8-6-5-CountdownLatch" class="headerlink" title="8.6.5  CountdownLatch"></a>8.6.5  CountdownLatch</h3><h4 id="8-6-5-1-基本使用"><a href="#8-6-5-1-基本使用" class="headerlink" title="8.6.5.1 基本使用"></a>8.6.5.1 基本使用</h4><p>用来进行线程同步协作，等待所有线程完成倒计时。</p>
<p>其中构造参数用来初始化等待计数值，await() 用来等待计数归零，countDown() 用来让计数减一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>	CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>		sleep(<span class="hljs-number">1</span>);<br>		latch.countDown();<br>		log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>	&#125;<br>	).start();<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>		sleep(<span class="hljs-number">2</span>);<br>		latch.countDown();<br>		log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>	&#125;<br>	).start();<br>	<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>		sleep(<span class="hljs-number">1.5</span>);<br>		latch.countDown();<br>		log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>	&#125;<br>	).start();<br>	log.debug(<span class="hljs-string">&quot;waiting...&quot;</span>);<br>	latch.await();<br>	log.debug(<span class="hljs-string">&quot;wait end...&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">00.778</span> c.TestCountDownLatch [main] - waiting... <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">00.778</span> c.TestCountDownLatch [Thread-<span class="hljs-number">2</span>] - begin... <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">00.778</span> c.TestCountDownLatch [Thread-<span class="hljs-number">0</span>] - begin... <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">00.778</span> c.TestCountDownLatch [Thread-<span class="hljs-number">1</span>] - begin... <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">01.782</span> c.TestCountDownLatch [Thread-<span class="hljs-number">0</span>] - end..<span class="hljs-number">.2</span> <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">02.283</span> c.TestCountDownLatch [Thread-<span class="hljs-number">2</span>] - end..<span class="hljs-number">.1</span> <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">02.782</span> c.TestCountDownLatch [Thread-<span class="hljs-number">1</span>] - end..<span class="hljs-number">.0</span> <br><span class="hljs-number">18</span>:<span class="hljs-number">44</span>:<span class="hljs-number">02.782</span> c.TestCountDownLatch [main] - wait end...<br></code></pre></td></tr></table></figure>



<p>可以配合线程池使用，改进如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>	CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);<br>	ExecutorService service = Executors.newFixedThreadPool(<span class="hljs-number">4</span>);<br>	service.submit(() -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>		sleep(<span class="hljs-number">1</span>);<br>		latch.countDown();<br>		log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>	&#125;<br>	);<br>	service.submit(() -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>		sleep(<span class="hljs-number">1.5</span>);<br>		latch.countDown();<br>		log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>	&#125;<br>	);<br>	service.submit(() -&gt; &#123;<br>		log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>		sleep(<span class="hljs-number">2</span>);<br>		latch.countDown();<br>		log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>	&#125;<br>	);<br>	service.submit(()-&gt;&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			log.debug(<span class="hljs-string">&quot;waiting...&quot;</span>);<br>			latch.await();<br>			log.debug(<span class="hljs-string">&quot;wait end...&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>	&#125;<br>	);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">25.831</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>] - begin... <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">25.831</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] - begin... <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">25.831</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] - begin... <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">25.831</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span>] - waiting... <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">26.835</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] - end..<span class="hljs-number">.2</span> <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">27.335</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] - end..<span class="hljs-number">.1</span> <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">27.835</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>] - end..<span class="hljs-number">.0</span> <br><span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">27.835</span> c.TestCountDownLatch [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span>] - wait end...<br></code></pre></td></tr></table></figure>



<h4 id="8-6-5-2-【应用】同步等待多线程准备完毕"><a href="#8-6-5-2-【应用】同步等待多线程准备完毕" class="headerlink" title="8.6.5.2 【应用】同步等待多线程准备完毕"></a>8.6.5.2 【应用】同步等待多线程准备完毕</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">AtomicInteger num = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);<br><br>ExecutorService service = Executors.newFixedThreadPool(<span class="hljs-number">10</span>, (r) -&gt; &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Thread(r, <span class="hljs-string">&quot;t&quot;</span> + num.getAndIncrement());<br>&#125;);<br><br>CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">10</span>);<br>String[] all = <span class="hljs-keyword">new</span> String[<span class="hljs-number">10</span>];<br>Random r = <span class="hljs-keyword">new</span> Random();<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10</span>; j++) &#123;<br>	<span class="hljs-keyword">int</span> x = j;<br>	service.submit(() -&gt; &#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">100</span>; i++) &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				Thread.sleep(r.nextint(<span class="hljs-number">100</span>));<br>			&#125;<span class="hljs-keyword">catch</span> (InterruptedException e) &#123;&#125;<br>			all[x] = Thread.currentThread().getName() + <span class="hljs-string">&quot;(&quot;</span> + (i + <span class="hljs-string">&quot;%&quot;</span>) + <span class="hljs-string">&quot;)&quot;</span>;<br>			System.out.print(<span class="hljs-string">&quot;r&quot;</span> + Arrays.toString(all));<br> &#125;<br> latch.countDown();<br> &#125;);<br>&#125;<br>latch.await();<br>System.out.println(<span class="hljs-string">&quot;n游戏开始...&quot;</span>);<br>service.shutdown();<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">[t0(<span class="hljs-number">100</span>%), t1(<span class="hljs-number">100</span>%), t2(<span class="hljs-number">100</span>%), t3(<span class="hljs-number">100</span>%), t4(<span class="hljs-number">100</span>%), t5(<span class="hljs-number">100</span>%), t6(<span class="hljs-number">100</span>%), t7(<span class="hljs-number">100</span>%), t8(<span class="hljs-number">100</span>%), <br>t9(<span class="hljs-number">100</span>%)] <br>游戏开始...<br></code></pre></td></tr></table></figure>



<h3 id="8-6-6-CyclicBarrier"><a href="#8-6-6-CyclicBarrier" class="headerlink" title="8.6.6 CyclicBarrier"></a>8.6.6 CyclicBarrier</h3><p>[ˈsaɪklɪk ˈbæriɚ] 循环栅栏，用来进行线程协作，等待线程满足某个计数。构造时设置『计数个数』，每个线程执行到某个需要“同步”的时刻调用 await() 方法进行等待，当等待的线程数满足『计数个数』时，继续执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">CyclicBarrier cb = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">2</span>);<br><span class="hljs-comment">// 个数为2时才会继续执行</span><br><br><span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>	System.out.println(<span class="hljs-string">&quot;线程1开始..&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>	<span class="hljs-keyword">try</span> &#123;<br>		cb.await();<br>		<span class="hljs-comment">// 当个数不足时，等待</span><br>	&#125;<span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;<br>		e.printStackTrace();<br>	&#125;<br>	System.out.println(<span class="hljs-string">&quot;线程1继续向下运行...&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>&#125;).start();<br><br><span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>	System.out.println(<span class="hljs-string">&quot;线程2开始..&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>	<span class="hljs-keyword">try</span> &#123;<br>		Thread.sleep(<span class="hljs-number">2000</span>);<br>	&#125;<span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>	&#125;<br>	<span class="hljs-keyword">try</span> &#123;<br>		cb.await();<br>		<span class="hljs-comment">// 2 秒后，线程个数够2，继续运行</span><br>	&#125;<span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;<br>		e.printStackTrace();<br>	&#125;<br>	System.out.println(<span class="hljs-string">&quot;线程2继续向下运行...&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>&#125;).start()<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong> CyclicBarrier 与 CountDownLatch 的主要区别在于 CyclicBarrier 是可以重用的 CyclicBarrier 可以被比喻为『人满发车』</p>
<p>线程数和计数要一样！</p>
</blockquote>
<h2 id="8-7-线程安全集合类概述"><a href="#8-7-线程安全集合类概述" class="headerlink" title="8.7 线程安全集合类概述"></a>8.7 线程安全集合类概述</h2><p><img src="http://image.cryptomartin.top/img/image-20220125221907757.png" srcset="/img/loading.gif" lazyload alt="image-20220125221907757"></p>
<p>线程安全集合类可以分为三大类：</p>
<ul>
<li>遗留的线程安全集合如 Hashtable ， Vector</li>
<li>使用 Collections 装饰的线程安全集合，如：<ul>
<li>Collections.synchronizedCollection</li>
<li>Collections.synchronizedList</li>
<li>Collections.synchronizedMap</li>
<li>Collections.synchronizedSet</li>
<li>Collections.synchronizedNavigableMap</li>
<li>Collections.synchronizedNavigableSet </li>
<li>Collections.synchronizedSortedMap</li>
<li>Collections.synchronizedSortedSet</li>
</ul>
</li>
<li>java.util.concurrent.*</li>
</ul>
<p>重点介绍<code>java.util.concurrent.*</code>下的线程安全集合类，可以发现它们有规律，里面包含三类关键词：<code>Blocking</code>、<code>CopyOnWrite</code>、<code>Concurrent</code></p>
<ul>
<li>Blocking 大部分实现基于锁(reentrantlock)，并提供用来阻塞的方法</li>
<li>CopyOnWrite 之类容器修改开销相对较重</li>
<li>Concurrent 类型的容器<ul>
<li>内部很多操作使用 cas 优化，一般可以提供较高吞吐量</li>
<li>弱一致性<ul>
<li>遍历时 弱一致性，例如，当利用迭代器遍历时，如果容器发生修改，迭代器仍然可以继续进行遍历，这时内容是旧的</li>
<li>求大小 弱一致性，size 操作未必是 100% 准确</li>
<li>读取 弱一致性</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>遍历时如果发生了修改，对于非安全容器来讲，使用 fail-fast 机制也就是让遍历立刻失败，抛ConcurrentModificationException，不再继续遍历</p>
</blockquote>
<h2 id="8-8-ConcurrentHashMap"><a href="#8-8-ConcurrentHashMap" class="headerlink" title="8.8 ConcurrentHashMap"></a>8.8 ConcurrentHashMap</h2><h3 id="8-8-1-练习：单词计数"><a href="#8-8-1-练习：单词计数" class="headerlink" title="8.8.1 练习：单词计数"></a>8.8.1 练习：单词计数</h3><p>生成测试数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ALPHA = <span class="hljs-string">&quot;abcedfghijklmnopqrstuvwxyz&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>	<span class="hljs-keyword">int</span> length = ALPHA.length();<br>	<span class="hljs-keyword">int</span> count = <span class="hljs-number">200</span>;<br>	List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(length * count);<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>		<span class="hljs-keyword">char</span> ch = ALPHA.charAt(i);<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; count; j++) &#123;<br>			list.add(String.valueOf(ch));<br>		&#125;<br>	&#125;<br>	Collections.shuffle(list);<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">26</span>; i++) &#123;<br>		<span class="hljs-keyword">try</span> (PrintWriter out = <span class="hljs-keyword">new</span> PrintWriter(<br>				 <span class="hljs-keyword">new</span> OutputStreamWriter(<br>				 <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;tmp/&quot;</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">&quot;.txt&quot;</span>)))) &#123;<br>			String collect = list.subList(i * count, (i + <span class="hljs-number">1</span>) * count).stream()<br>						 .collect(Collectors.joining(<span class="hljs-string">&quot;n&quot;</span>));<br>			out.print(collect);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (IOException e) &#123;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>模版代码，模版代码中封装了多线程读取文件的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;V&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">demo</span><span class="hljs-params">(Supplier&lt;Map&lt;String,V&gt;&gt; supplier, </span></span><br><span class="hljs-params"><span class="hljs-function">BiConsumer&lt;Map&lt;String,V&gt;,List&lt;String&gt;&gt; consumer)</span> </span>&#123;<br>	Map&lt;String, V&gt; counterMap = supplier.get();<br>	List&lt;Thread&gt; ts = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">26</span>; i++) &#123;<br>		<span class="hljs-keyword">int</span> idx = i;<br>		Thread thread = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			List&lt;String&gt; words = readFromFile(idx);<br>			consumer.accept(counterMap, words);<br>		&#125;<br>		);<br>		ts.add(thread);<br>	&#125;<br>	ts.forEach(t-&gt;t.start());<br>	ts.forEach(t-&gt; &#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			t.join();<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>	&#125;<br>	);<br>	System.out.println(counterMap);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title">readFromFile</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>	ArrayList&lt;String&gt; words = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	<span class="hljs-keyword">try</span> (BufferedReader in = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;tmp/&quot;</span><br>	+ i +<span class="hljs-string">&quot;.txt&quot;</span>)))) &#123;<br>		<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;<br>			String word = in.readLine();<br>			<span class="hljs-keyword">if</span>(word == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			words.add(word);<br>		&#125;<br>		<span class="hljs-keyword">return</span> words;<br>	&#125;<br>	<span class="hljs-keyword">catch</span> (IOException e) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>你要做的是实现两个参数</p>
<ul>
<li>一是提供一个 map 集合，用来存放每个单词的计数结果，key 为单词，value 为计数</li>
<li>二是提供一组操作，保证计数的安全性，会传递 map 集合以及 单词 List</li>
</ul>
<p>正确结果输出应该是每个单词出现 200 次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;a=<span class="hljs-number">200</span>, b=<span class="hljs-number">200</span>, c=<span class="hljs-number">200</span>, d=<span class="hljs-number">200</span>, e=<span class="hljs-number">200</span>, f=<span class="hljs-number">200</span>, g=<span class="hljs-number">200</span>, h=<span class="hljs-number">200</span>, i=<span class="hljs-number">200</span>, j=<span class="hljs-number">200</span>, k=<span class="hljs-number">200</span>, l=<span class="hljs-number">200</span>, m=<span class="hljs-number">200</span>, <br>n=<span class="hljs-number">200</span>, o=<span class="hljs-number">200</span>, p=<span class="hljs-number">200</span>, q=<span class="hljs-number">200</span>, r=<span class="hljs-number">200</span>, s=<span class="hljs-number">200</span>, t=<span class="hljs-number">200</span>, u=<span class="hljs-number">200</span>, v=<span class="hljs-number">200</span>, w=<span class="hljs-number">200</span>, x=<span class="hljs-number">200</span>, y=<span class="hljs-number">200</span>, z=<span class="hljs-number">200</span>&#125;<br></code></pre></td></tr></table></figure>



<p>下面的实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">demo(<br> <span class="hljs-comment">// 创建 map 集合</span><br><span class="hljs-comment">// 创建 ConcurrentHashMap 对不对？</span><br>() -&gt; <span class="hljs-keyword">new</span> HashMap&lt;String, Integer&gt;(),<br> <span class="hljs-comment">// 进行计数</span><br>(map, words) -&gt; &#123;<br>	<span class="hljs-keyword">for</span> (String word : words) &#123;<br>		Integer counter = map.get(word);<br>		<span class="hljs-keyword">int</span> newValue = counter == <span class="hljs-keyword">null</span> ? <span class="hljs-number">1</span> : counter + <span class="hljs-number">1</span>;<br>		map.put(word, newValue);<br>	&#125;<br>&#125;<br>);<br></code></pre></td></tr></table></figure>

<p>改进1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">demo(<br> () -&gt; <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;String, LongAdder&gt;(),<br> (map, words) -&gt; &#123;<br>	<span class="hljs-keyword">for</span> (String word : words) &#123;<br>		<span class="hljs-comment">// 注意不能使用 putIfAbsent，此方法返回的是上一次的 value，首次调用返回 null</span><br>		map.computeIfAbsent(word, (key) -&gt; <span class="hljs-keyword">new</span> LongAdder()).increment();<br>	&#125;<br>&#125;<br>);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>computeIfAbsent() 方法对 hashMap 中指定 key 的值进行重新计算，如果不存在这个 key，则添加到 hashMap 中.</p>
<p>返回值：</p>
<p>如果 key 对应的 value 不存在，则使用获取 remappingFunction 重新计算后的值，并保存为该 key 的 value；否则返回 value。</p>
</blockquote>
<h3 id="8-8-2-【原理】ConcurrentHashMap"><a href="#8-8-2-【原理】ConcurrentHashMap" class="headerlink" title="8.8.2 【原理】ConcurrentHashMap"></a>8.8.2 【原理】ConcurrentHashMap</h3><p><strong>JDK7 HashMap并发死链</strong></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd?p=277&share_source=copy_web">hashmap并发死链IDEA调式过程P277-P280</a></p>
</li>
<li><p>jdk1.7中 hashmap为什么会发生死链？ - 磊哥的回答 - 知乎 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/394039290/answer/2314917909">https://www.zhihu.com/question/394039290/answer/2314917909</a></p>
</li>
</ul>
<p><strong>JDK8 ConcurrentHashMap</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd?p=281">JDK8 ConcurrentHashMap P281-289</a></li>
</ul>
<p><strong>JDK7 ConcurrentHashMap</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd?p=290">JDK7 ConcurrentHashMap P290-P296</a></li>
</ul>
<h2 id="8-9-LinkedBlockingQueue"><a href="#8-9-LinkedBlockingQueue" class="headerlink" title="8.9 LinkedBlockingQueue"></a>8.9 LinkedBlockingQueue</h2><h3 id="8-9-1-基本的入队出队"><a href="#8-9-1-基本的入队出队" class="headerlink" title="8.9.1 基本的入队出队"></a>8.9.1 基本的入队出队</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinkedBlockingQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueue</span>&lt;<span class="hljs-title">E</span>&gt;</span><br><span class="hljs-class"> <span class="hljs-keyword">implements</span> <span class="hljs-title">BlockingQueue</span>&lt;<span class="hljs-title">E</span>&gt;, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>&lt;<span class="hljs-title">E</span>&gt; </span>&#123;<br>		E item;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 下列三种情况之一</span><br><span class="hljs-comment">         * - 真正的后继节点</span><br><span class="hljs-comment">         * - 自己, 发生在出队时</span><br><span class="hljs-comment">         * - null, 表示是没有后继节点, 是最后了</span><br><span class="hljs-comment">         */</span><br>		Node&lt;E&gt; next;<br>		Node(E x) &#123;<br>			item = x;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>初始化链表<code>last = head = new Node&lt;E&gt;(null);</code>Dummy 节点用来占位，item 为<code>null</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162436633.png" srcset="/img/loading.gif" lazyload alt="image-20220126162436633"></p>
<p>当一个节点入队<code>last = last.next = node;</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162523059.png" srcset="/img/loading.gif" lazyload alt="image-20220126162523059"></p>
<p>再来一个节点入队<code>last = last.next = node;</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162613412.png" srcset="/img/loading.gif" lazyload alt="image-20220126162613412"></p>
<p>出队</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Node&lt;E&gt; h = head;<br>Node&lt;E&gt; first = h.next; <br>h.next = h; <span class="hljs-comment">// help GC</span><br>head = first; <br>E x = first.item;<br>first.item = <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">return</span> x;<br></code></pre></td></tr></table></figure>

<p><code>Node&lt;E&gt; h = head;</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162650414.png" srcset="/img/loading.gif" lazyload alt="image-20220126162650414"></p>
<p><code>Node&lt;E&gt; first = h.next; </code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162807975.png" srcset="/img/loading.gif" lazyload alt="image-20220126162807975"></p>
<p><code>h.next = h;</code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162834085.png" srcset="/img/loading.gif" lazyload alt="image-20220126162834085"></p>
<p><code>head = first; </code></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126162914943.png" srcset="/img/loading.gif" lazyload alt="image-20220126162914943"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">E x = first.item;<br>first.item = <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">return</span> x;<br></code></pre></td></tr></table></figure>

<p><img src="http://image.cryptomartin.top/img/image-20220126162934056.png" srcset="/img/loading.gif" lazyload alt="image-20220126162934056"></p>
<h3 id="8-9-2-加锁分析"><a href="#8-9-2-加锁分析" class="headerlink" title="8.9.2 加锁分析"></a>8.9.2 加锁分析</h3><p>==高明之处==在于用了两把锁和 dummy 节点</p>
<ul>
<li>用一把锁，同一时刻，最多只允许有一个线程（生产者或消费者，二选一）执行</li>
<li>用两把锁，同一时刻，可以允许两个线程同时（一个生产者与一个消费者）执行<ul>
<li>消费者与消费者线程仍然串行</li>
<li>生产者与生产者线程仍然串行</li>
</ul>
</li>
</ul>
<p>线程安全分析</p>
<ul>
<li>当节点总数大于 2 时（包括 dummy 节点），putLock 保证的是 last 节点的线程安全，takeLock 保证的是head 节点的线程安全。两把锁保证了入队和出队没有竞争</li>
<li>当节点总数等于 2 时（即一个 dummy 节点，一个正常节点）这时候，仍然是两把锁锁两个对象，不会竞争</li>
<li>当节点总数等于 1 时（就一个 dummy 节点）这时 take 线程会被 notEmpty 条件阻塞，有竞争，会阻塞</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 用于 put(阻塞) offer(非阻塞)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantLock putLock = <span class="hljs-keyword">new</span> ReentrantLock();<br><span class="hljs-comment">// 用户 take(阻塞) poll(非阻塞)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantLock takeLock = <span class="hljs-keyword">new</span> ReentrantLock();<br></code></pre></td></tr></table></figure>



<p><strong>put操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(E e)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>    <span class="hljs-keyword">if</span> (e == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>    <span class="hljs-keyword">int</span> c = -<span class="hljs-number">1</span>;<br>    Node&lt;E&gt; node = <span class="hljs-keyword">new</span> Node&lt;E&gt;(e);<br>    <span class="hljs-keyword">final</span> ReentrantLock putLock = <span class="hljs-keyword">this</span>.putLock;<br>    <span class="hljs-comment">// count 用来维护元素计数</span><br>    <span class="hljs-keyword">final</span> AtomicInteger count = <span class="hljs-keyword">this</span>.count;<br>    putLock.lockInterruptibly();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 满了等待</span><br>        <span class="hljs-keyword">while</span> (count.get() == capacity) &#123;<br>            <span class="hljs-comment">// 倒过来读就好: 等待 notFull</span><br>            notFull.await();<br>        &#125;<br>        <span class="hljs-comment">// 有空位, 入队且计数加一</span><br>        enqueue(node);<br>        c = count.getAndIncrement();<br>        <span class="hljs-comment">// 除了自己 put 以外, 队列还有空位, 由自己叫醒其他 put 线程</span><br>        <span class="hljs-keyword">if</span> (c + <span class="hljs-number">1</span> &lt; capacity)<br>         notFull.signal();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        putLock.unlock();<br>    &#125;<br>    <span class="hljs-comment">// 如果队列中有一个元素, 叫醒 take 线程</span><br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>)<br>     <span class="hljs-comment">// 这里调用的是 notEmpty.signal() 而不是 notEmpty.signalAll() 是为了减少竞争</span><br>    signalNotEmpty();<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>take操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>    E x;<br>    <span class="hljs-keyword">int</span> c = -<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">final</span> AtomicInteger count = <span class="hljs-keyword">this</span>.count;<br>    <span class="hljs-keyword">final</span> ReentrantLock takeLock = <span class="hljs-keyword">this</span>.takeLock;<br>    takeLock.lockInterruptibly();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">while</span> (count.get() == <span class="hljs-number">0</span>) &#123;<br>            notEmpty.await();<br>        &#125;<br>        x = dequeue();<br>        c = count.getAndDecrement();<br>        <span class="hljs-keyword">if</span> (c &gt; <span class="hljs-number">1</span>)<br>         notEmpty.signal();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        takeLock.unlock();<br>    &#125;<br>    <span class="hljs-comment">// 如果队列中只有一个空位时, 叫醒 put 线程</span><br>    <span class="hljs-comment">// 如果有多个线程进行出队, 第一个线程满足 c == capacity, 但后续线程 c &lt; capacity</span><br>    <span class="hljs-keyword">if</span> (c == capacity)<br>     <span class="hljs-comment">// 这里调用的是 notFull.signal() 而不是 notFull.signalAll() 是为了减少竞争</span><br>    signalNotFull()<br>      <span class="hljs-keyword">return</span> x;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>由 put 唤醒 put <strong>是为了避免信号不足</strong></p>
</blockquote>
<h3 id="8-9-3-性能比较"><a href="#8-9-3-性能比较" class="headerlink" title="8.9.3 性能比较"></a>8.9.3 性能比较</h3><p>主要列举 LinkedBlockingQueue 与 ArrayBlockingQueue 的性能比较</p>
<ul>
<li>Linked 支持有界，Array 强制有界</li>
<li>Linked 实现是链表，Array 实现是数组</li>
<li>Linked 是懒惰的，而 Array 需要提前初始化 Node 数组</li>
<li>Linked 每次入队会生成新 Node，而 Array 的 Node 是提前创建好的</li>
<li>Linked 两把锁，Array 一把锁</li>
</ul>
<h2 id="8-10-ConcurrentLinkedQueue"><a href="#8-10-ConcurrentLinkedQueue" class="headerlink" title="8.10 ConcurrentLinkedQueue"></a>8.10 ConcurrentLinkedQueue</h2><p>ConcurrentLinkedQueue 的设计与 LinkedBlockingQueue 非常像，也是</p>
<ul>
<li>两把【锁】，同一时刻，可以允许两个线程同时（一个生产者与一个消费者）执行</li>
<li>dummy 节点的引入让两把【锁】将来锁住的是不同对象，避免竞争</li>
<li>只是这【锁】使用了 cas 来实现</li>
</ul>
<p>事实上，ConcurrentLinkedQueue 应用还是非常广泛的</p>
<p>例如之前讲的 Tomcat 的 Connector 结构时，Acceptor 作为生产者向 Poller 消费者传递事件信息时，正是采用了<br>ConcurrentLinkedQueue 将 SocketChannel 给 Poller 使用</p>
<p><img src="http://image.cryptomartin.top/img/image-20220126164738074.png" srcset="/img/loading.gif" lazyload alt="image-20220126164738074"></p>
<h2 id="8-11-CopyOnWriteArrayList"><a href="#8-11-CopyOnWriteArrayList" class="headerlink" title="8.11 CopyOnWriteArrayList"></a>8.11 CopyOnWriteArrayList</h2><p><code>CopyOnWriteArraySet</code>是它的马甲 底层实现采用了<code>写入时拷贝</code>的思想，增删改操作会将底层数组拷贝一份，更改操作在新数组上执行，这时不影响其它线程的并发读，读写分离。 以新增为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>    <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>        <span class="hljs-comment">// 获取旧的数组</span><br>        Object[] es = getArray();<br>        <span class="hljs-keyword">int</span> len = es.length;<br>        <span class="hljs-comment">// 拷贝新的数组（这里是比较耗时的操作，但不影响其它读线程）</span><br>        es = Arrays.copyOf(es, len + <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 添加新元素</span><br>        es[len] = e;<br>        <span class="hljs-comment">// 替换旧的数组</span><br>        setArray(es);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这里的源码版本是 Java 11，在 Java 1.8 中使用的是可重入锁而不是 synchronized</p>
</blockquote>
<p>其它读操作并未加锁，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">forEach</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-keyword">super</span> E&gt; action)</span> </span>&#123;<br> Objects.requireNonNull(action);<br> <span class="hljs-keyword">for</span> (Object x : getArray()) &#123;<br> 	<span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span> E e = (E) x;<br> 	action.accept(e);<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p>适合『读多写少』的应用场景</p>
</blockquote>
<p><strong>get 弱一致性</strong></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126164944526.png" srcset="/img/loading.gif" lazyload alt="image-20220126164944526"></p>
<p><img src="http://image.cryptomartin.top/img/image-20220126164952906.png" srcset="/img/loading.gif" lazyload alt="image-20220126164952906"></p>
<p><strong>迭代器弱一致性</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">CopyOnWriteArrayList&lt;Integer&gt; list = <span class="hljs-keyword">new</span> CopyOnWriteArrayList&lt;&gt;();<br>list.add(<span class="hljs-number">1</span>);<br>list.add(<span class="hljs-number">2</span>);<br>list.add(<span class="hljs-number">3</span>);<br>Iterator&lt;Integer&gt; iter = list.iterator();<br><span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>    list.remove(<span class="hljs-number">0</span>);<br>    System.out.println(list);<br>&#125;).start();<br><br>sleep1s();<br><span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>    System.out.println(iter.next());<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>不要觉得弱一致性就不好</p>
<ul>
<li>数据库的 MVCC 都是弱一致性的表现</li>
<li>并发高和一致性是矛盾的，需要权衡</li>
</ul>
</blockquote>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E9%AB%98%E5%B9%B6%E5%8F%91/">高并发</a>
                    
                      <a class="hover-with-bg" href="/categories/%E9%AB%98%E5%B9%B6%E5%8F%91/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">高并发</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/01/%E7%AC%AC%E4%B8%83%E7%AB%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%8D%E5%8F%AF%E5%8F%98/">
                        <span class="hidden-mobile">第七章 共享模型之不可变</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
